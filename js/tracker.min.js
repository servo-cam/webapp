const app={version:"0.9.2",source:"CAMERA",sourceVideo:"",sourceStream:"",sourceRemote:"",model:"MoveNetSinglePoseLightning",init:function(){try{storage.loadConfig()}catch(e){console.error(e)}app.prepare(app.model),app.prepareModel(),tracker.on("statuschange",(function(e){app.updateStatus(e)})),tracker.on("beforeupdate",(function(){sorter.append(),app.updateCounter()})),tracker.on("afterupdate",(function(){app.updateDebug(),"OFF"!=config.target.mode&&targeting.update(),command.update(),$("#device_status").text(tracker.remoteStatus)})),tracker.run(app.source),manual.init(),document.getElementById("canvas").onmousemove=function(e){tracker.mouseX=e.clientX,tracker.mouseY=e.clientY,debug.handlePointerCoords()},document.getElementById("canvas").onmousedown=function(e){manual.onMouseClick(e)},window.onmouseup=function(e){manual.onMouseRelease(e)}},prepareModel:function(){switch(app.model){case"OpenCVMotionDetector":tracker.setWrapper(OpenCVMotionDetector),tracker.setModel("OpenCVMotionDetector");break;case"MobileNet":tracker.setWrapper(mobilenet),tracker.setModel("mobilenet");break;case"MoveNetSinglePoseLightning":case"MoveNetSinglePoseThunder":case"MoveNetMultiPoseLightning":tracker.setWrapper(movenet),tracker.setModel(app.model)}},prepare:function(e=""){const t=new URLSearchParams(window.location.search);t.has("model")&&""!=t.get("model")&&(app.model=t.get("model")),t.has("source")&&(app.source=t.get("source")),t.has("url")&&(app.sourceVideo=t.get("url"),"VIDEO"==app.source?config.init.video=app.sourceVideo:"STREAM"==app.source?(app.sourceStream=t.get("url"),config.init.stream=app.sourceVideo):"REMOTE"==app.source&&(app.sourceRemote=t.get("url"),config.init.remote=app.sourceRemote)),$(document).ready((function(){try{app.initConfig()}catch(e){console.error(e)}app.setupUI(),shortcuts.assign()}))},setupUI:function(){$("body").on("click","#canvas",(function(e){e.preventDefault(),ui.clickCoords={x:tracker.mouseX,y:tracker.mouseY}})),$("body").on("click",".source-select",(function(e){e.preventDefault();let t="?model="+app.model+"&source="+$(this).attr("data-source");app.source==$(this).attr("data-source")&&(t=t+"&url="+app.sourceVideo),window.location.href=t})),$("body").on("change","#model_select",(function(e){e.preventDefault();const t="?model="+$(this).val()+"&source="+app.source+"&url="+app.sourceVideo;window.location.href=t})),$("body").on("change",'button[data-trigger="btn-ai-toggle"]',(function(e){e.preventDefault(),app.sourceVideo=$("#video_src").val();const t="?model="+window.model+"&source="+app.source+"&url="+app.sourceVideo;window.location.href=t})),$("body").on("change","#camera_select",(function(e){e.preventDefault();const t=$(this).val();""!=t&&null!=t&&camera.selectDevice(t)})),$("body").on("click",'button[data-trigger="btn-ai-toggle"]',(function(e){e.preventDefault(),app.toggleAI()})),$("body").on("click",'button[data-trigger="btn-debug-toggle"]',(function(e){e.preventDefault(),app.toggleDebug()})),$("body").on("click",'button[data-trigger="btn-3d-toggle"]',(function(e){e.preventDefault(),app.toggle3D()})),$("body").on("click",'button[data-trigger="btn-video-toggle"]',(function(e){e.preventDefault(),app.toggleVideo()})),$("body").on("click",'button[data-trigger="btn-controls-toggle"]',(function(e){e.preventDefault(),app.toggleControls()})),$("body").on("click",'button[data-trigger="btn-usb-connect"]',(function(e){e.preventDefault(),app.toggleSerial()})),$("body").on("click",'button[data-trigger="btn-play-control"]',(function(e){e.preventDefault(),video.playPauseClick()})),$("body").on("click",'button[data-trigger="btn-play-controls"]',(function(e){e.preventDefault(),app.togglePlayControls()})),$("body").on("click",'button[data-trigger="btn-show-bounds"]',(function(e){e.preventDefault(),app.toggleBounds()})),$("body").on("click",'button[data-trigger="btn-console-toggle"]',(function(e){e.preventDefault(),app.toggleConsole()})),$("body").on("click",'button[data-trigger="btn-console-pause"]',(function(e){e.preventDefault(),app.toggleConsolePause()})),$("body").on("click",'button[data-trigger="btn-console-clear"]',(function(e){e.preventDefault(),app.toggleConsoleClear()})),$("body").on("click",'button[data-trigger="btn-console-send"]',(function(e){e.preventDefault(),app.toggleConsoleSend()})),$("body").on("click",'button[data-trigger="btn-area-select"]',(function(e){e.preventDefault(),app.toggleAreaSelect(null)})),$("body").on("click",'button[data-trigger="btn-control-mode-select"]',(function(e){e.preventDefault(),app.toggleControlMode($(this).attr("data-id"))})),$("body").on("click",'button[data-trigger="btn-control-manual-mode"]',(function(e){e.preventDefault(),app.toggleControlManualMode($(this).attr("data-id"))})),$("body").on("click",'button[data-trigger="btn-target-point-select"]',(function(e){e.preventDefault(),app.toggleTargetPoint($(this).attr("data-id"))})),$("body").on("click",'button[data-trigger="btn-target-single-only"]',(function(e){e.preventDefault(),app.toggleSingleTarget()})),$("body").on("click",'button[data-trigger="btn-attack-toggle"]',(function(e){e.preventDefault(),app.toggleActionMode()})),$("body").on("click",'button[data-trigger="btn-servo-simulator"]',(function(e){e.preventDefault(),app.toggleSimulator()})),$("body").on("click",'button[data-trigger="btn-view-resize"]',(function(e){e.preventDefault(),app.toggleView($(this).attr("data-id"))})),$("body").on("click",'button[data-trigger="btn-servo"]',(function(e){e.preventDefault(),app.toggleServo()})),$("body").on("click",'button[data-trigger="btn-servo-horizontal"]',(function(e){e.preventDefault(),app.toggleServoHorizontal()})),$("body").on("click",'button[data-trigger="btn-servo-vertical"]',(function(e){e.preventDefault(),app.toggleServoVertical()})),$("body").on("click",'button[data-trigger="btn-switch-target"]',(function(e){e.preventDefault(),app.toggleSwitchtarget($(this).attr("data-id"))})),$("body").on("click",'button[data-trigger="btn-target-lock"]',(function(e){e.preventDefault(),app.toggleTargetLock()})),$("body").on("click",'button[data-trigger="btn-center-lock"]',(function(e){e.preventDefault(),app.toggleCenterLock()})),$("body").on("click",'button[data-trigger="btn-center"]',(function(e){e.preventDefault(),app.toggleCenter()})),$("body").on("click",'button[data-trigger="btn-action"]',(function(e){e.preventDefault();const t=$(this).attr("data-id");action.isManualToggle?action.isToggled(t)?(action.end(t),ui.disableBtn("btn-action",t),app.toggleAction(null,!1)):(action.begin(t),ui.enableBtn("btn-action",t,"danger"),app.toggleAction(t,!1)):app.toggleAction(t,!0)})),$("body").on("click",'button[data-trigger="btn-action-switch"]',(function(e){e.preventDefault(),app.toggleActionSwitch()})),$("body").on("change",'select[data-trigger="auto_action_name"]',(function(e){e.preventDefault();const t=$(this).val();app.toggleActionAutoName(t,!1)})),$("body").on("change",'select[data-trigger="auto_action_mode"]',(function(e){e.preventDefault();const t=$(this).val();app.toggleActionAutoMode(t,!1)})),$("body").on("change",'input[data-role="area_config_value"]',(function(e){e.preventDefault();const t=$(this).attr("data-parent"),r=$(this).attr("data-id"),o=$(this).val().trim();app.updateAreaConfig(t,r,o)})),$("body").on("keyup",'input[data-role="area_config_value"]',(function(e){e.preventDefault();const t=$(this).attr("data-parent"),r=$(this).attr("data-id"),o=$(this).val().trim();app.updateAreaConfig(t,r,o)})),$("body").on("change",'select[data-role="area_config_value"]',(function(e){e.preventDefault();const t=$(this).attr("data-parent"),r=$(this).val();app.updateAreaConfig(t,"mode",r)})),$("body").on("click",'button[data-trigger="btn-config-load"]',(function(e){e.preventDefault(),storage.loadConfig()})),$("body").on("click",'button[data-trigger="btn-config-save"]',(function(e){e.preventDefault(),storage.saveConfig()})),$("body").on("click",'button[data-trigger="btn-config-reset"]',(function(e){e.preventDefault(),storage.resetConfig()}))},toggleAI:function(e=!1){config.core.enableAI&&!e?(config.core.enableAI=!1,console.log("AI ON")):(config.core.enableAI=!0,console.log("AI OFF"))},toggleVideo:function(e=!1){config.core.enableVideo&&!e?(config.core.enableVideo=!1,console.log("Video OFF")):(console.log("Video ON"),config.core.enableVideo=!0)},toggle3D:function(){tracker.detectorModel==poseDetection.SupportedModels.BlazePose?null!=tracker.scatterGL?config.core.enable3D?(config.core.enable3D=!1,config.dom.scatter3d.style.display="none",console.log("3D OFF")):(console.log("3D ON"),config.core.enable3D=!0,config.dom.scatter3d.style.display="block",tracker.scatterGL.resize()):console.error("ScatterGL is not initialized"):alert("3D is available for BlazePose model only!")},toggleDebug:function(e=!1){config.core.enableDebug&&!e?(config.core.enableDebug=!1,$("#debug_main").html(""),$("#debug_servo").html(""),$("#debug_custom").html(""),$("#debug_main").hide(),$("#debug_servo").hide(),$("#debug_custom").hide(),debug.disablePointerCoords(),console.log("Debug OFF")):(config.core.enableDebug=!0,$("#debug_main").show(),$("#debug_servo").show(),$("#debug_custom").show(),debug.enablePointerCoords(),console.log("Debug ON"))},toggleConsole:function(e=!1){config.core.enableConsole&&!e?(config.core.enableConsole=!1,$("#debug_console").hide(),console.log("Console OFF")):(config.core.enableConsole=!0,$("#debug_console").show(),$("#console_input").focus(),console.log("Console ON"))},toggleControls:function(e=!1){const t=$(".control-panel");"none"!=t.css("display")||e?t.hide():t.show()},togglePlayControls:function(e=!1){$("#video").hasClass("video-control")&&!e?($("#video").removeClass("video-control"),ui.disableBtn("btn-play-controls")):($("#video").addClass("video-control"),ui.enableBtn("btn-play-controls"))},toggleBounds:function(e=!1){config.render.bounds&&!e?(config.render.bounds=!1,ui.disableBtn("btn-show-bounds")):(config.render.bounds=!0,ui.enableBtn("btn-show-bounds"))},toggleConsolePause:function(){dbg_console.isPaused()?(dbg_console.resume(),ui.disableBtn("btn-console-pause")):(dbg_console.pause(),ui.enableBtn("btn-console-pause"))},toggleConsoleClear:function(){dbg_console.clear()},toggleConsoleSend:function(){const e=$("#console_input"),t=e.val().trim();""!=t&&dbg_console.onSend(t),e.val(""),e.focus()},toggleControlMode:function(e){ui.disableBtn("btn-control-mode-select"),ui.enableBtn("btn-control-mode-select",e),config.target.mode=e,"PATROL"!=e?(patrol.stop(),config.patrol.enabled=!1):config.patrol.enabled=!0,manual.toggleManualControls()},toggleControlManualMode:function(e){ui.disableBtn("btn-control-manual-mode"),ui.enableBtn("btn-control-manual-mode",e),config.manual.mode=e},toggleTargetPoint:function(e){ui.disableBtn("btn-target-point-select"),ui.enableBtn("btn-target-point-select",e),config.target.point=e},toggleSingleTarget:function(e=!1){config.target.single&&!e?(config.target.single=!1,ui.disableBtn("btn-target-single-only")):(config.target.single=!0,ui.enableBtn("btn-target-single-only",null,"success"))},toggleActionAutoName:function(e,t=!0){config.action.auto_name=e,t&&$('select[data-trigger="auto_action_name"]').val(e)},toggleActionAutoMode:function(e,t=!0){config.action.auto_mode=e,t&&$('select[data-trigger="auto_action_mode"]').val(e)},toggleActionMode:function(e=!1){config.action.enabled&&!e?(action.isActive()&&action.stop(),config.action.enabled=!1,ui.disableBtn("btn-attack-toggle")):(config.action.enabled=!0,ui.enableBtn("btn-attack-toggle",null,"danger"),"FOLLOW"!=config.target.mode&&"PATROL"!=config.target.mode&&(config.target.mode="FOLLOW",ui.disableBtn("btn-control-mode-select"),ui.enableBtn("btn-control-mode-select","FOLLOW")),targets.isLocked()||targets.lock())},toggleSerial:async function(){await serial.connect()},toggleSimulator:function(e=!1){config.render.simulator&&!e?(config.render.simulator=!1,ui.disableBtn("btn-servo-simulator"),render.clearSimulator()):(servo.isEnabled()&&app.toggleServo(),config.render.locked&&app.toggleCenterLock(),config.render.simulator=!0,ui.enableBtn("btn-servo-simulator"))},toggleView:function(e){switch(ui.disableBtn("btn-view-resize"),ui.enableBtn("btn-view-resize",e),e){case"RESIZED":config.render.resize=!0,config.render.view=!0,$("#canvas").removeClass("canvas-original"),$("#canvas").addClass("canvas-resize");break;case"ORIGINAL":config.render.resize=!1,config.render.view=!0,$("#canvas").removeClass("canvas-resize"),$("#canvas").addClass("canvas-original");break;case"DISABLED":config.render.resize=!0,config.render.view=!1}},toggleAreaSelect:function(e=null){null==e?ui.panelEnabled("area")?(ui.hidePanel("area"),ui.disableBtn("btn-area-select")):(ui.showPanel("area"),ui.enableBtn("btn-area-select")):e&&(ui.showPanel("area"),ui.enableBtn("btn-area-select"));const t=["TARGET","PATROL","ACTION"],r=["xMin","yMin","width","height"];let o;for(let e of t){for(let t of r)$('input[data-role="area_config_value"][data-parent="'+e+'"][data-id="'+t+'"]').val(config.area.box[e.toLowerCase()][t]);o=config.area.enabled[e.toLowerCase()]?config.area.world[e.toLowerCase()]?"WORLD":"CAM":"OFF",$('select[data-role="area_config_value"][data-parent="'+e+'"][data-id="mode"]').val(o)}},updateAreaConfig:function(e,t,r){const o=e.toLowerCase();switch(t){case"xMin":if(r=r.trim(),isNaN(r)||""==r||null==r)return;config.area.box[o].xMin=parseFloat(r);break;case"yMin":if(r=r.trim(),isNaN(r)||""==r||null==r)return;config.area.box[o].yMin=parseFloat(r);break;case"width":if(r=r.trim(),isNaN(r)||""==r||null==r)return;config.area.box[o].width=parseFloat(r);break;case"height":if(r=r.trim(),isNaN(r)||""==r||null==r)return;config.area.box[o].height=parseFloat(r);break;case"mode":switch(r){case"OFF":config.area.enabled[o]=!1;break;case"CAM":config.area.enabled[o]=!0,config.area.world[o]=!1;break;case"WORLD":config.area.enabled[o]=!0,config.area.world[o]=!0}}},toggleServo:async function(e=!1){servo.isEnabled()&&!e?servo.disable():(targeting.center(),config.render.simulator&&app.toggleSimulator(),config.render.locked||app.toggleCenterLock(),serial.enabled||await serial.connect(!0),servo.enable())},toggleTargetLock:function(e=!1){targets.isLocked()&&!e?targets.unlock():targets.lock()},toggleAction:function(e,t=!0){action.show(e),command.update(e),t?setTimeout((function(){action.hide()}),10):null==e&&action.hide()},toggleActionSwitch:function(){action.isManualToggle?(action.isManualToggle=!1,ui.disableBtn("btn-action-switch"),action.hide()):(ui.enableBtn("btn-action-switch",null,"danger"),action.isManualToggle=!0,action.show())},toggleCenterLock:function(e=!1){config.render.locked&&!e?(config.render.locked=!1,ui.disableBtn("btn-center-lock")):(config.render.simulator&&app.toggleSimulator(),servo.isEnabled()&&app.toggleServo(),targeting.center(),config.render.locked=!0,ui.enableBtn("btn-center-lock"))},toggleCenter:function(){targeting.center()},toggleServoHorizontal:function(e=!1){config.servo.horizontal&&!e?(config.servo.horizontal=!1,ui.disableBtn("btn-servo-horizontal")):(config.servo.horizontal=!0,ui.enableBtn("btn-servo-horizontal"))},toggleServoVertical:function(e=!1){config.servo.vertical&&!e?(config.servo.vertical=!1,ui.disableBtn("btn-servo-vertical")):(config.servo.vertical=!0,ui.enableBtn("btn-servo-vertical"))},toggleSwitchtarget:function(e){"PREV"==e?targets.prev():"NEXT"==e&&targets.next()},updateStatus:function(e){document.getElementById("status").innerHTML=e},updateCounter:function(){let e=tracker.objects.length,t=tracker.countDetected();$("#info_target_counter").html(t+"/"+e)},updateDebug:function(){dbg_console.listen(),config.core.enableDebug&&(debug.showDebug(),debug.showServoDebug(),debug.showCustomDebug())},initConfig:function(){switch($("#model_select").val(app.model),$("#source-"+app.source.toLowerCase()).addClass("active"),config.patrol.enabled&&(config.target.mode="PATROL"),app.toggleTargetPoint(config.target.point),app.toggleControlMode(config.target.mode),app.toggleControlManualMode(config.manual.mode),app.toggleActionAutoName(config.action.auto_name),app.toggleActionAutoMode(config.action.auto_mode),config.render.locked&&app.toggleCenterLock(!0),config.render.bounds&&app.toggleBounds(!0),config.action.enabled&&app.toggleActionMode(!0),config.render.simulator&&app.toggleSimulator(!0),config.target.locked&&app.toggleTargetLock(!0),config.target.single&&app.toggleSingleTarget(!0),config.servo.horizontal&&app.toggleServoHorizontal(!0),config.servo.vertical&&app.toggleServoVertical(!0),null!=config.camera.deviceId&&camera.selectDevice(config.camera.deviceId),config.core.enableDebug&&app.toggleDebug(!0),config.core.enableConsole&&app.toggleConsole(!0),config.panel.area&&app.toggleAreaSelect(config.panel.area),config.render.view?config.render.resize?ui.enableBtn("btn-view-resize","RESIZED"):ui.enableBtn("btn-view-resize","ORIGINAL"):ui.enableBtn("btn-view-resize","DISABLED"),app.source){case"CAMERA":$("#video_area").hide(),$("#canvas").addClass("camera"),$("#camera_select").addClass("d-inline");break;case"VIDEO":$("#video_area").show(),null!=app.sourceVideo&&""!=app.sourceVideo.trim()||(app.sourceVideo=config.init.video),$("#video source").attr("src",app.sourceVideo),$("#video").attr("src",app.sourceVideo),$("#video_src").val(app.sourceVideo),$("#video_src_prefix").html("MP4,AVI,MKV,WEBM"),$("#canvas").addClass("clickable"),$("#panel_video").show(),$("body").on("click",'button[data-trigger="btn-load-video"]',(function(e){e.preventDefault();const t=$("#video_src").val(),r="?model="+$(this).val()+"&source="+app.source+"&url="+t;window.location.href=r,video.load(t)}));break;case"STREAM":$("#video_area").show(),null!=app.sourceVideo&&""!=app.sourceVideo.trim()||(app.sourceVideo=config.init.stream),$("#video source").attr("src",app.sourceVideo),$("#video_src").val(app.sourceVideo),$("#video_src_prefix").html("IPTV STREAM,m3u8"),$("#canvas").addClass("clickable"),$("#panel_video").show(),$("body").on("click",'button[data-trigger="btn-load-video"]',(function(e){const t=$("#video_src").val();stream.load(t)}));break;case"REMOTE":if($("#video_area").show(),null!=app.sourceRemote&&""!=app.sourceRemote.trim()||(app.sourceRemote=config.init.remote),$("body").on("click",'button[data-trigger="btn-load-video"]',(function(e){const t=$("#video_src").val();remote.load(t)})),null==app.sourceRemote||""==app.sourceRemote)return void alert("No address specified. Not connected!");$("#remote").attr("src",app.sourceRemote+remote.appendToken()),$("#video source").attr("src",app.sourceRemote+remote.appendToken()),$("#video_src").val(app.sourceRemote),$("#video_src_prefix").html("REMOTE"),$("#canvas").addClass("clickable"),$("#panel_video").show()}}},action={active:!1,actionInterval:null,targetInterval:null,actionCounter:0,targetCounter:0,stopped:!1,isManualToggle:!1,isSingleAction:!1,actions:["A1","A2","A3","B4","B5","B6"],toggled:{A1:!1,A2:!1,A3:!1,B4:!1,B5:!1,B6:!1},begin:function(e){action.toggled[e]=!0},end:function(e){action.toggled[e]=!1},update:function(){if(action.actionCounter>config.action.timeout.action_length){switch(config.action.auto_mode){case"SINGLE":action.actionCounter=0,action.stopped=!0,action.isSingleAction=!1,action.hide();break;case"CONTINUOUS":action.actionCounter=0,action.begin(config.action.auto_name),action.stopped=!0,action.hide();break;case"SERIES":action.hide(),command.update(config.action.auto_name),action.actionCounter=0}if("TOGGLE"!=config.action.auto_mode)return}action.targetCounter++,action.targetCounter>=config.action.timeout.next_target&&(action.targetCounter=0,targets.next()),action.stopped||(action.actionCounter++,action.show())},start:function(){switch(action.active=!0,action.stopped=!1,config.action.auto_mode){case"SINGLE":case"SERIES":command.update(config.action.auto_name),action.actionCounter=config.action.timeout.action_length-1;break;case"CONTINUOUS":action.toggled[config.action.auto_name]=!0,action.actionCounter=0,command.update();break;case"TOGGLE":action.toggled[config.action.auto_name]=!0,action.actionCounter=0}action.targetCounter=0,null==action.actionInterval&&(action.actionInterval=setInterval((function(){action.actionCounter++}),10)),null==action.targetInterval&&(action.targetInterval=setInterval((function(){action.targetCounter++}),10)),action.show()},stop:function(){action.active=!1,action.actionCounter=0,action.targetCounter=0,action.stopped=!1,action.isSingleAction=!1,action.hide(),command.update(),action.clear()},isToggled:function(e){return e in action.toggled&&action.toggled[e]},toggle:function(e){action.isToggled(e)?action.toggled[e]=!1:action.toggled[e]=!0},enable:function(){config.action.enabled=!0},disable:function(){config.action.enabled=!1,action.clear()},isActive:function(){return action.active},isEnabled:function(){return config.action.enabled},hasAction:function(){for(let e in action.actions)if(action.toggled[e])return!0;return!1},show:function(e=null){ui.statusAlert("target-action")},hide:function(){ui.statusAlert("target-action",!1)},clear:function(){null!=action.actionInterval&&(clearInterval(action.actionInterval),action.actionInterval=null),null!=action.targetInterval&&(clearInterval(action.targetInterval),action.targetInterval=null),action.toggled={A1:!1,A2:!1,A3:!1,B4:!1,B5:!1,B6:!1}}},area={inArea:function(e,t){const r=t.toLowerCase();if(void 0===config.area.box[r].xMin||null==config.area.box[r].xMin||void 0===config.area.box[r].yMin||null==config.area.box[r].yMin||void 0===config.area.box[r].width||null==config.area.box[r].width||void 0===config.area.box[r].height||null==config.area.box[r].height||0==config.area.box[r].width||0==config.area.box[r].height)return!1;let o=config.area.box[r].xMin,a=config.area.box[r].yMin;config.area.world[r]||(o-=tracker.dx,a-=tracker.dy);let n=o+config.area.box[r].width,i=a+config.area.box[r].height;return e.x>=o&&e.x<=n&&e.y>=a&&e.y<=i},getMiddleHeight:function(e,t){const r=t.toLowerCase();if(void 0===e.xMin||null==e.xMin||void 0===e.yMin||null==e.yMin||void 0===e.width||null==e.width||void 0===e.height||null==e.height||0==e.width||0==e.height)return!1;let o=e.yMin,a=o+e.height,n=e.yMin+tracker.dy,i=n+e.height;return config.area.world[r]?(a+o)/2:(n+i)/2}},command={initialized:!1,prev:{x:90,y:90},next:{x:90,y:90},sendCmd:{x:!1,y:!1},angle:{x:0,y:0},current:null,init:function(){command.prev.x=config.servo.initAngle.x,command.prev.y=config.servo.initAngle.y,command.next.x=config.servo.initAngle.x,command.next.y=config.servo.initAngle.y},prepare:function(){command.angle=servo.deltaToAngle(),config.servo.horizontal&&(command.next.x=parseInt(command.angle.x+config.servo.maxAngle.x/2)),config.servo.vertical&&(command.next.y=parseInt(command.angle.y+config.servo.maxAngle.y/2)),command.next.x<config.servo.minAngle.x&&(command.next.x=config.servo.minAngle.x),command.next.x>config.servo.maxAngle.x&&(command.next.x=config.servo.maxAngle.x),command.next.y<config.servo.minAngle.y&&(command.next.y=config.servo.minAngle.y),command.next.y>config.servo.maxAngle.y&&(command.next.y=config.servo.maxAngle.y),command.next.x<config.servo.minLimit.x&&(command.next.x=config.servo.minLimit.x),command.next.x>config.servo.maxLimit.x&&(command.next.x=config.servo.maxLimit.x),command.next.y<config.servo.minLimit.y&&(command.next.y=config.servo.minLimit.y),command.next.y>config.servo.maxLimit.y&&(command.next.y=config.servo.maxLimit.y)},build:function(){command.sendCmd.x=!1,command.sendCmd.y=!1,command.prev.x==command.next.x||0!=config.servo.angleStep&&command.next.x%config.servo.angleStep!=0||(command.sendCmd.x=!0),command.prev.y==command.next.y||0!=config.servo.angleStep&&command.next.y%config.servo.angleStep!=0||(command.sendCmd.y=!0),command.prev.x=command.next.x,command.prev.y=command.next.y},update:function(e=null){command.initialized||(command.init(),command.initialized=!0),command.prepare(),command.build(),cmdAry=[],cmdAry.push(command.prev.x),cmdAry.push(command.prev.y),cmdAry.push(tracker.countDetected());for(let t of action.actions)t==e||action.toggled[t]?cmdAry.push(1):cmdAry.push(0);command.send(cmdAry.join(config.command.serial.delimiter))},send:function(e){if(e!=command.current){if(command.current=e,serial.enabled)switch(config.command.serial.format){case"RAW":e+=config.command.serial.endchar,serial.send(e),console.log("SERIAL SEND RAW: "+e);break;case"JSON":json=JSON.stringify({cmd:e}),serial.send(json),console.log("SERIAL SEND JSON: "+json)}if("remote"==config.init.mode){let t;switch(config.command.remote.format){case"RAW":t=app.sourceRemote+config.command.remote.path+"?cmd="+e+remote.appendToken(),$.get(t,(function(e){tracker.remoteStatus=e}));break;case"JSON":t=app.sourceRemote+config.command.remote.path+remote.appendToken(),$.post(t,{cmd:e},(function(e){try{tmp=JSON.parse(e).cmd,tracker.remoteStatus=tmp}catch(e){}}))}}}}},dbg_console={paused:!1,items:[],handle:function(e){},onSend:function(e){dbg_console.log("CMD: ",e,!0),dbg_console.handle(e)},log:function(e,t,r=!1){if(!dbg_console.paused||r){const r=new Date;e="["+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds()+":"+r.getMilliseconds()+"] "+e,dbg_console.items.push(debug.item(e,t,!1))}console.log(e,t)},listen:function(){for(let e in dbg_console.items)$("#debug_console .items ul").append("<li>"+dbg_console.items[e]+"</li>"),dbg_console.items.splice(e,1)},clear:function(){$("#debug_console .items ul").html("")},pause:function(){dbg_console.paused=!0},resume:function(){dbg_console.paused=!1},isPaused:function(){return dbg_console.paused}},debug={pointerCoords:!1,custom:[],console:[],paused:!1,showConsole:!1,prevCode:null,showServoDebug:function(){let e=[];for(i in e.push(debug.item(debug.tag(config.target.point,"orange"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("SERVO X"))),e.push(debug.item(debug.val("LEFT: "))),targeting.move.left&&e.push(debug.item(debug.val("+"),null,!1)),e.push(debug.item(debug.val("RIGHT: "))),targeting.move.right&&e.push(debug.item(debug.val("+"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("SERVO Y"))),e.push(debug.item(debug.val("UP: "))),targeting.move.up&&e.push(debug.item(debug.val("+"),null,!1)),e.push(debug.item(debug.val("DOWN: "))),targeting.move.down&&e.push(debug.item(debug.val("+"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("target"),debug.vector(targeting.target))),e.push(debug.item(debug.title("beforeTarget"),debug.vector(targeting.beforeTarget))),e.push(debug.item(debug.title("now"),debug.vector(targeting.now))),e.push(debug.item(debug.title("cam"),debug.vector(targeting.cam))),e.push(debug.nl()),e.push(debug.item(debug.title("distCN"),debug.vector(targeting.distCN))),e.push(debug.item(debug.title("percCN %"),debug.vector(targeting.percCN))),e.push(debug.item(debug.title("distNT"),debug.vector(targeting.distNT))),e.push(debug.item(debug.title("percNT %"),debug.vector(targeting.percNT))),e.push(debug.item(debug.title("speed"),debug.vector(targeting.speed))),e.push(debug.item(debug.title("threshold"),debug.vector(targeting.th))),e.push(debug.item(debug.title("power"),debug.vector(targeting.power))),e.push(debug.item(debug.title("cam"),debug.vector(targeting.cam))),e.push(debug.nl()),e.push(debug.item(debug.title("dx"),debug.val(tracker.dx.toFixed(2)+" / max "+(config.servo.maxAngle.x/config.camera.fov.x).toFixed(2)))),e.push(debug.item(debug.title("dy"),debug.val(tracker.dy.toFixed(2)+" / max "+(config.servo.maxAngle.y/config.camera.fov.y).toFixed(2)))),e.push(debug.nl()),e.push(debug.item(debug.title("angle.x","white"),debug.val(command.angle.x+"^ / "+command.prev.x,"white"))),command.sendCmd.x&&e.push(debug.item(debug.tag("SEND","yellow"),null,!1)),e.push(debug.item(debug.title("angle.y","white"),debug.val(command.angle.y+"^ / "+command.prev.y,"white"))),command.sendCmd.y&&e.push(debug.item(debug.tag("SEND","yellow"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("SCORE"),debug.val(keypoints.score.toFixed(2)))),e.push(debug.nl()),e.push(debug.item(debug.title("PREV TARGET"))),targeting.prevTarget)e.push(debug.item(debug.title(i),debug.vector(targeting.prevTarget[i])));for(i in e.push(debug.nl()),e.push(debug.item(debug.title("PREV NOW"))),targeting.prevNow)e.push(debug.item(debug.title(i),debug.vector(targeting.prevNow[i])));for(i in e.push(debug.nl()),e.push(debug.item(debug.title("PREV CAM"))),targeting.prevCam)e.push(debug.item(debug.title(i),debug.vector(targeting.prevCam[i])));e.push(debug.nl()),e.push(debug.item(debug.title("FOV"),debug.vector(config.camera.fov))),e.push(debug.item(debug.title("ANGLE"),debug.vector(config.servo.maxAngle))),e.push(debug.nl()),e.push(debug.item(debug.title("CODE"),debug.val(serial.code))),debug.prevCode!=serial.code&&(e.push(debug.item(debug.tag("SEND","yellow"),null,!1)),debug.prevCode=serial.code),e.push(debug.item(debug.title("CMD"),debug.val(command.current))),serial.enabled||e.push(debug.item(debug.tag("NO SERIAL","orange"),null,!1)),$("#debug_servo").html(e.join(""))},showDebug:function(){let e=[];const t=upscaler.getVideoSize(),r=(upscaler.getCanvas(),upscaler.getCanvasSize()),o=upscaler.getCurrentCanvasSize(),a=upscaler.fit();e.push(debug.item(debug.tag(config.target.mode,"orange"),null,!1)),patrol.isActive()&&e.push(debug.item(debug.tag("PATROL","lime"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("CANVAS (CURRENT)"),debug.dim(o))),e.push(debug.item(debug.title("CANVAS (INITIAL)"),debug.dim(r))),e.push(debug.item(debug.title("VIEW"),debug.dim(a))),e.push(debug.item(debug.title("VIDEO"),debug.dim(t))),e.push(debug.nl()),e.push(debug.item(debug.title("OBJ IDX"),debug.val(targets.objIdx))),e.push(debug.item(debug.title("OBJ TMP IDX"),debug.val(targets.tmpObjIdx))),e.push(debug.item(debug.title("OBJ IDENTIFIER"),debug.val(targets.identifier))),e.push(debug.item(debug.title("OBJ TMP IDENTIFIER"),debug.val(targets.tmpIdentifier))),e.push(debug.item(debug.title("CHANGE IDX"),debug.val(targets.changeIdx))),e.push(debug.nl()),e.push(debug.item(debug.title("MATCH"),debug.val(targets.matchType))),targets.isSearch()&&e.push(debug.item(debug.tag("SEARCH","lime"),null,!1)),targets.hasTarget()&&e.push(debug.item(debug.tag("TARGET","red"),null,!1)),e.push(debug.nl()),e.push(debug.item(debug.title("targets.center.last"),debug.vector(targets.center.last))),e.push(debug.item(debug.title("targets.center.current"),debug.vector(targets.center.current))),e.push(debug.item(debug.title("targets.box.current"),debug.bound(targets.box.current))),e.push(debug.item(debug.title("targets.box.lock"),debug.bound(targets.box.lock))),e.push(debug.item(debug.title("targets.box.last")));for(let t in targets.box.last)null!=targets.box.last[t]&&e.push(debug.item(debug.title(" -- ["+t+"]"),debug.bound(targets.box.last[t])));e.push(debug.nl()),e.push(debug.item(debug.title("target.counter.on"),debug.val(target.counter.on))),e.push(debug.item(debug.title("target.counter.leave"),debug.val(target.counter.leave))),e.push(debug.nl()),e.push(debug.item(debug.title("isControl"),debug.bool(targeting.isControl))),e.push(debug.item(debug.title("search"),debug.bool(targets.search))),e.push(debug.item(debug.title("locked"),debug.bool(config.target.locked))),e.push(debug.item(debug.title("matched"),debug.bool(targets.matched))),e.push(debug.item(debug.title("single"),debug.bool(config.target.single))),e.push(debug.item(debug.title("isLost"),debug.bool(targets.isLost()))),e.push(debug.item(debug.title("isTarget"),debug.bool(targets.hasTarget()))),e.push(debug.nl()),e.push(debug.item(debug.title("action enabled"),debug.bool(config.action.enabled))),e.push(debug.item(debug.title("action.active"),debug.bool(action.active))),e.push(debug.item(debug.title("action.counter"),debug.val(action.counter))),e.push(debug.nl());let n=0,i=0;for(let t of tracker.objects){e.push(debug.nl());let r="<b>["+n+"]";if(r+=' <span style="color:orange">'+t.class+"</span>",r+=" ("+Math.round(100*t.score,2)+"%)",void 0!==t.id&&(r+=" ID: "+t.id),r+="</b>",e.push(debug.val(r)),void 0!==t.center&&(e.push(debug.item(debug.title("CENTER"),debug.vector(t.center))),keypoints.inBounding(t.center,targets.box.last,n)?e.push(debug.item(debug.tag("MATCHED PREV","lime"),null,!1)):e.push(debug.item(debug.tag("LEAVED","red"),null,!1))),targets.isMatched&&e.push(debug.item(debug.tag("MATCHED","lime",null,!0))),void 0!==t.box&&e.push(debug.item(debug.title("BOX"),debug.bound(t.box))),i=0,void 0!==t.keypoints)for(let r of t.keypoints)e.push(debug.item(debug.kpoint(i,r))),i++;e.push(debug.nl()),n++}$("#debug_main").html(e.join(""))},log:function(e,t,r=!1){("string"==typeof e||e instanceof String)&&(e+=": "),debug.custom.push(debug.item(e,t)),r&&dbg_console.log(e,t)},showCustomDebug:function(){$("#debug_custom").html(debug.custom.join("")),debug.custom=[]},handlePointerCoords:function(){if(!config.core.enableDebug)return;$("#debug_pointer").show();const e=upscaler.pointerToVideo(tracker.mouseX,tracker.mouseY),t=upscaler.pointerToVideoTransform(tracker.mouseX,tracker.mouseY),r=upscaler.pointerToVideoDeltaNormalized(tracker.mouseX,tracker.mouseY),o=servo.deltaToAngle({x:r.x,y:r.y}),a=upscaler.getVideoSize();let n=0,i=0;n=window.innerWidth/2>=tracker.mouseX?25:-140,i=window.innerHeight/2>=tracker.mouseY?25:-120,$("#debug_pointer").css("top",tracker.mouseY+i+"px"),$("#debug_pointer").css("left",tracker.mouseX+n+"px");let c=[];c.push(debug.item(debug.title("m"),debug.val(tracker.mouseX+", "+tracker.mouseY),!1)),c.push(debug.item(debug.title("p"),debug.val(parseInt(e.x)+", "+parseInt(e.y)))),c.push(debug.item(debug.title("t"),debug.val(parseInt(t.x)+", "+parseInt(t.y)))),c.push(debug.item(debug.title("o"),debug.val((t.x/a.width).toFixed(2)+", "+(t.y/a.height).toFixed(2)))),c.push(debug.item(debug.title("s"),debug.val(parseInt(upscaler.translateX(t.x))+", "+parseInt(upscaler.translateY(t.y))))),c.push(debug.item(debug.title("d"),debug.val(r.x.toFixed(2)+", "+r.y.toFixed(2)))),c.push(debug.item(debug.title("a"),debug.val(o.x.toFixed(2)+", "+o.y.toFixed(2)))),$("#debug_pointer").html(c.join(""))},title:function(e,t=null){return null!=t?'<b style="color: '+t+'">'+e+":</b> ":"<b>"+e+":</b> "},vector:function(e){if(null!=e&&void 0!==e.x&&void 0!==e.y)return e.x.toFixed(2)+", "+e.y.toFixed(2)},kpoint:function(e,t){let r=e+": ";return void 0!==t.name&&(r=t.name),void 0!==t.x&&(r+=", ",r=r+"x:"+parseInt(t.x)),void 0!==t.y&&(r+=", ",r=r+"y:"+parseInt(t.y)),void 0!==t.z&&(r+=", ",r=r+"z:"+parseInt(t.z)),void 0!==t.score&&(r+=", ",r=r+"s:"+t.score.toFixed(2)),r},bound:function(e){if(null!=e&&void 0!==e.xMin&&void 0!==e.yMin&&void 0!==e.width&&void 0!==e.height&&null!=e.xMin)return e.xMin.toFixed(3)+", "+e.yMin.toFixed(3)+", "+e.width.toFixed(3)+", "+e.height.toFixed(3)},dim:function(e){if(null!=e&&void 0!==e.width&&void 0!==e.height)return e.width+"x"+e.height},nl:function(){return"<br/>"},val:function(e,t=null){return null!=t?'<span style="color: '+t+'">'+e+"</span>":e},bool:function(e){return 1==e?'<span style="color: lime">TRUE</span>':'<span style="color: red">FALSE</span>'},item:function(e,t="",r=!0){let o="";return null==t&&(t=""),r&&(o+="<br/>"),o+e+t},tag:function(e,t="red"){return' <span style="color: '+t+'; font-weight: bold">['+e+"]</span>"},enablePointerCoords:function(){debug.pointerCoords=!0,$("#debug_pointer").show()},disablePointerCoords:function(){debug.pointerCoords=!1,$("#debug_pointer").hide()}},filters={notAllowed:function(e){return!(!config.area.enabled.target||area.inArea(tracker.objects[e].center,"TARGET"))}},finder={find:function(){targets.matchType="";let e=null,t=null,r=null,o=null;targets.isLocked()?(e=targets.objIdx,t=targets.identifier,r=targets.box.lock,o=targets.center.last):(e=targets.objIdx,t=targets.tmpIdentifier,r=targets.box.current,o=targets.center.current);let a={all_1:function(e,t,r,o){return matcher.matchExactly(e,r,o,!1)},all_2:function(e,t,r,o){return matcher.matchExactly(e,null,o,!0)},curr_id:function(e,t,r,o){return matcher.matchExactly(e,null,o,!1)},close_id:function(e,t,r,o){return matcher.matchClosest(t,o)},close_search:function(e,t,r,o){if(targets.isSearch()||!targets.isLocked()&&!config.target.single||action.isEnabled())return matcher.matchClosest(t)}},n=null;for(let i in a)if(n=a[i](r,o,e,t),null!=n){targets.matchType=i;break}return n},findNext:function(){let e=targets.center.last,t=null;for(idx in tracker.objects)if(void 0!==tracker.objects[idx].center&&tracker.objects[idx].center.x>=e.x&&idx!=targets.objIdx){t=idx;break}return t},findPrev:function(){let e=targets.center.last,t=null;for(idx in tracker.objects)if(void 0!==tracker.objects[idx].center&&tracker.objects[idx].center.x<=e.x&&idx!=targets.objIdx){t=idx;break}return t},findFirst:function(){let e=null,t=null;for(idx in tracker.objects)void 0!==tracker.objects[idx].center&&(null==e||tracker.objects[idx].center.x<e)&&(e=tracker.objects[idx].center.x,t=idx);return t},findLast:function(){let e=null,t=null;for(idx in tracker.objects)void 0!==tracker.objects[idx].center&&(null==e||tracker.objects[idx].center.x>e)&&(e=tracker.objects[idx].center.x,t=idx);return t}},tracker={wrapper:null,hooks:{beforeupdate:[],afterupdate:[],statuschange:[],detectorerror:[],videoerror:[]},remoteStatus:"",reqID:null,isPlaying:!1,isWaiting:!1,isInitialized:!1,started:!1,ready:!1,objects:[],video:null,canvas:null,ctx:null,sourceCanvas:null,sourceCtx:null,status:"",anchors3D:[[0,0,0],[0,1,0],[-1,0,0],[-1,-1,0]],scatterGL:null,scatterGLEl:null,scatterGLInitialized:!1,videoJS:null,dx:0,dy:0,mouseX:0,mouseY:0,run:function(e){switch(tracker.isInitialized||tracker.prepare(),e){case"VIDEO":video.init();break;case"CAMERA":camera.init();break;case"STREAM":stream.init();break;case"REMOTE":remote.init()}},prepare:function(){null!=tracker.wrapper&&(tracker.wrapper.onPrepare(),tracker.isInitialized=!0)},init3D:function(){null!=tracker.scatterGLEl&&(tracker.scatterGL=new ScatterGL(tracker.scatterGLEl,{rotateOnStart:!0,selectEnabled:!1,styles:{polyline:{defaultOpacity:1,deselectedOpacity:1},fog:{enabled:!1}}}))},init:function(){tracker.log("Initializing..."),tracker.video=document.querySelector(config.dom.video),tracker.canvas=document.querySelector(config.dom.canvas),tracker.sourceCanvas=document.querySelector(config.dom.source_canvas),tracker.scatterGLEl=document.querySelector(config.dom.scatter3d),tracker.ctx=tracker.canvas.getContext("2d"),tracker.sourceCtx=tracker.sourceCanvas.getContext("2d"),null!=tracker.wrapper&&tracker.wrapper.onInit()},handle:function(){null!=tracker.wrapper&&tracker.wrapper.beforeUpdate(),tracker.dispatch("beforeupdate",null),render.append(),ui.handlePointerEvents(),tracker.dispatch("afterupdate",null)},detect:function(){if(config.core.enableAI&&null!=tracker.video)try{null!=tracker.wrapper&&tracker.wrapper.onFrame()}catch(e){tracker.dispatch("detectorerror",e),console.error(e)}},clearCanvas:function(){tracker.ctx.save(),tracker.ctx.setTransform(1,0,0,1,0,0),tracker.ctx.clearRect(0,0,tracker.canvas.width,tracker.canvas.height),tracker.ctx.restore()},log:function(...e){config.core.log&&dbg_console.log("[TRACKER] ",...e)},setStatus:function(e){tracker.status=e,tracker.dispatch("statuschange",tracker.status)},on:function(e,t){void 0!==tracker.hooks[e]&&tracker.hooks[e].push(t)},dispatch:function(e,t){if(void 0!==tracker.hooks[e])for(const r of tracker.hooks[e])r(t,tracker)},setModel:function(e){config.init.modelName=e,tracker.wrapper.onSetModel(e)},setWrapper:function(e){tracker.wrapper=e},setTargetMode:function(e){config.target.mode=e},countDetected:function(){let e=0;if(tracker.objects)for(obj of tracker.objects)obj.score>=config.model.minScore&&e++;return e}},keypoints={score:0,createBoundingBox:function(e){const t=upscaler.getVideoSize(),r={xMin:null,yMin:null,width:null,height:null};if(void 0===tracker.objects[e])return r;let o;for(point of tracker.objects[e].keypoints)point.score<config.model.minScore||(o=point.x/t.width,(null==r.xMin||r.xMin>o)&&(r.xMin=o),(null==r.width||r.width<o)&&(r.width=o),o=point.y/t.height,(null==r.yMin||r.yMin>o)&&(r.yMin=o),(null==r.height||r.height<o)&&(r.height=o));return r.width=r.width-r.xMin,r.height=r.height-r.yMin,r},createCenterPoint:function(e){return void 0===tracker.objects[e].box?{x:0,y:0}:{x:tracker.objects[e].box.xMin+tracker.objects[e].box.width/2,y:tracker.objects[e].box.yMin+tracker.objects[e].box.height/2}},inBounding:function(e,t,r=null){if(null==r)return keypoints.checkBounding(e,t);if("*"!=r){if(void 0!==t[r])return keypoints.checkBounding(e,t[r])}else{let r=[];for(let o in t)if(keypoints.checkBounding(e,t[o]))return r[o]=keypoints.getBoundingScore(e,t[o]),!0}return!1},getBoundingScores:function(e,t){let r=[];for(let o in t)keypoints.checkBounding(e,t[o])&&(r[o]=keypoints.getBoundingScore(e,t[o]));return r},getBoundingScoresDict:function(e,t){let r=[];for(let o in t)keypoints.checkBounding(e,t[o].box)&&(r[o]=keypoints.getBoundingScore(e,t[o].box));return r},getCenterScores:function(e,t){let r=[];for(let o in t)void 0!==e.x&&void 0!==t[o].x&&(r[o]=keypoints.getCenterScore(e,t[o]));return r},checkBounding:function(e,t,r=!1){if(null==t)return!1;let o,a,n,i;upscaler.getVideoSize();return o=t.xMin,n=t.yMin,a=t.width,i=t.height,null!=e.x&&null!=e.y&&null!=o&&null!=n&&null!=a&&null!=i&&e.x>=o&&e.x<=o+a&&e.y>=n&&e.y<=n+i},getBoundingScore:function(e,t){const r=t.xMin+t.width/2,o=t.yMin+t.height/2;return Math.sqrt(Math.pow(r-e.x,2)+Math.pow(o-e.y,2))},getCenterScore:function(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},getDistance:function(e,t,r,o){const a=r-e,n=o-t;return Math.sqrt(a*a+n*n)},getCoordDistance:function(e,t){const r=t.x-e.x,o=t.y-e.y;return Math.sqrt(r*r+o*o)},calculateMeanCoordinate:function(e){let t=0,r=0;for(const o of e)t+=o.x,r+=o.y;return{x:t/e.length,y:r/e.length}}},manual={keys:{},btn:{},keyUP:38,keyLEFT:37,keyRIGHT:39,keyDOWN:40,move:!1,isMouseControl:!1,mouseStartCoords:{},mouseStopCoords:{},mouseDelta:{},x:0,y:1,moreDelta:{x:0,y:0},init:function(){document.body.onkeyup=document.body.onkeydown=function(e){const t=e.keyCode||e.which;e.preventDefault?"MANUAL"==config.target.mode&&e.preventDefault():e.returnValue=!1,manual.keys[t]="keydown"==e.type},$("document").ready((function(){$(".control-trigger").mousedown((function(e){e.preventDefault();const t=$(this).attr("data-id");switch(manual.x=0,manual.y=0,t){case"LEFT":manual.x=-1;break;case"RIGHT":manual.x=1;break;case"UP":manual.y=1;break;case"DOWN":manual.y=-1;break;case"SPEED_UP":config.manual.speed+=.01;break;case"SPEED_DOWN":config.manual.speed>.01&&(config.manual.speed-=.01)}manual.moveDirection(t),manual.move=!0,$(".control-speed-value").text(config.manual.speed.toFixed(2)+"x")})),$(".control-trigger").mouseleave((function(e){e.preventDefault();$(this).attr("data-id");manual.x=0,manual.y=0,manual.move=!1})),$("body").mouseup((function(e){e.preventDefault();$(this).attr("data-id");manual.x=0,manual.y=0,manual.move=!1})),manual.toggleManualControls()})),manual.moveCamera(),setInterval((function(){manual.detectMovement()}),1e3/24)},toggleManualControls:function(){"MANUAL"==config.target.mode?($(".control-speed-value").text(config.manual.speed+"x"),$("#panel_manual").show()):$("#panel_manual").hide(),"MANUAL"==config.target.mode||"MOUSE"==config.target.mode?$("#panel_mode_manual").show():$("#panel_mode_manual").hide()},moveCamera:function(e,t){min=servo.getMinDelta(!0),max=servo.getMaxDelta(!0),tracker.dx<=max.x&&tracker.dx>=min.x&&(tracker.dx+=(e||0)*config.manual.speed),tracker.dx>max.x?tracker.dx=max.x:tracker.dx<min.x&&(tracker.dx=min.x),tracker.dy+=(t||0)*config.manual.speed,tracker.dy>max.y?tracker.dy=max.y:tracker.dy<min.y&&(tracker.dy=min.y)},detectMovement:function(){(manual.keys[manual.keyLEFT]||manual.btn[manual.keyLEFT])&&manual.moveCamera(1,0),(manual.keys[manual.keyRIGHT]||manual.btn[manual.keyRIGHT])&&manual.moveCamera(-1,0),(manual.keys[manual.keyUP]||manual.btn[manual.keyUP])&&manual.moveCamera(0,1),(manual.keys[manual.keyDOWN]||manual.btn[manual.keyDOWN])&&manual.moveCamera(0,-1)},moveDirection:function(e){switch(e){case"UP":manual.moveCamera(0,1);break;case"DOWN":manual.moveCamera(0,-1);break;case"LEFT":manual.moveCamera(1,0);break;case"RIGHT":manual.moveCamera(-1,0);break;case"CENTER":targeting.center()}},keyControl:function(){targeting.power.x=4,targeting.power.y=4,manual.move?(manual.x>0?(manual.btn[manual.keyLEFT]=!1,manual.btn[manual.keyRIGHT]=!0):manual.x<0?(manual.btn[manual.keyLEFT]=!0,manual.btn[manual.keyRIGHT]=!1):(manual.btn[manual.keyLEFT]=!1,manual.btn[manual.keyRIGHT]=!1),manual.y>0?(manual.btn[manual.keyUP]=!0,manual.btn[manual.keyDOWN]=!1):manual.y<0?(manual.btn[manual.keyUP]=!1,manual.btn[manual.keyDOWN]=!0):(manual.btn[manual.keyUP]=!1,manual.btn[manual.keyDOWN]=!1)):manual.resetKeys()},onMouseClick:function(){manual.mouseDelta={x:tracker.dx,y:tracker.dy},manual.isMouseControl=!0;const e=upscaler.pointerToVideoTransform(tracker.mouseX,tracker.mouseY);manual.mouseStartCoords=upscaler.normalize(e)},onMouseRelease:function(){manual.isMouseControl=!1,manual.mouseDelta={},manual.mouseStartCoords={}},mouseControl:function(){if(!manual.isMouseControl)return;const e=upscaler.pointerToVideoDeltaNormalized(tracker.mouseX,tracker.mouseY),t=upscaler.pointerToVideoTransform(tracker.mouseX,tracker.mouseY),r=upscaler.normalize(t);switch(minDelta=servo.getMinDelta(!0),maxDelta=servo.getMaxDelta(!0),minCoords=servo.getMinCoords(!0),maxCoords=servo.getMaxCoords(!0),config.manual.mode){case"POINT":let t={x:r.x-manual.mouseStartCoords.x,y:r.y-manual.mouseStartCoords.y};config.render.simulator||config.render.locked?(tracker.dx<=maxDelta.x&&tracker.dx>=minDelta.x&&(tracker.dx=manual.mouseDelta.x+t.x),tracker.dy<=maxDelta.y&&tracker.dy>=minDelta.y&&(tracker.dy=manual.mouseDelta.y+t.y)):(tracker.dx<=maxDelta.x&&tracker.dx>=minDelta.x&&(tracker.dx=e.x),tracker.dy<=maxDelta.y&&tracker.dy>=minDelta.y&&(tracker.dy=e.y)),tracker.dx>maxDelta.x?tracker.dx=maxDelta.x:tracker.dx<minDelta.x&&(tracker.dx=minDelta.x),tracker.dy>maxDelta.y?tracker.dy=maxDelta.y:tracker.dy<minDelta.y&&(tracker.dy=minDelta.y);break;case"NOW":config.render.simulator||config.render.locked?(targeting.now.x<=maxCoords.x&&targeting.now.x>=minCoords.x&&(targeting.now.x=r.x-tracker.dx),targeting.now.y<=maxCoords.y&&targeting.now.y>=minCoords.y&&(targeting.now.y=r.y-tracker.dy)):(targeting.now.x<=maxCoords.x&&targeting.now.x>=minCoords.x&&(targeting.now.x=r.x),targeting.now.y<=maxCoords.y&&targeting.now.y>=minCoords.y&&(targeting.now.y=r.y)),targeting.now.x>maxCoords.x?targeting.now.x=maxCoords.x:targeting.now.x<minCoords.x&&(targeting.now.x=minCoords.x),targeting.now.y>maxCoords.y?targeting.now.y=maxCoords.y:targeting.now.y<minCoords.y&&(targeting.now.y=minCoords.y),targeting.setMovement();break;case"TARGET":null==targeting.target&&(targeting.target={x:.5,y:.5}),config.render.simulator||config.render.locked?(targeting.target.x<=maxCoords.x&&targeting.target.x>=minCoords.x&&(targeting.target.x=r.x-tracker.dx),targeting.target.y<=maxCoords.y&&targeting.target.y>=minCoords.y&&(targeting.target.y=r.y-tracker.dy)):(targeting.target.x<=maxCoords.x&&targeting.target.x>=minCoords.x&&(targeting.target.x=r.x),targeting.target.y<=maxCoords.y&&targeting.target.y>=minCoords.y&&(targeting.target.y=r.y)),targeting.target.x>maxCoords.x?targeting.target.x=maxCoords.x:targeting.target.x<minCoords.x&&(targeting.target.x=minCoords.x),targeting.target.y>maxCoords.y?targeting.target.y=maxCoords.y:targeting.target.y<minCoords.y&&(targeting.target.y=minCoords.y),targeting.setMovement()}},resetKeys:function(){manual.btn[manual.keyLEFT]=!1,manual.btn[manual.keyRIGHT]=!1,manual.btn[manual.keyUP]=!1,manual.btn[manual.keyDOWN]=!1}},matcher={matchExactly:function(e,t=null,r=null,o=!0){let a,n=0;for(let i of tracker.objects)if(i.score<config.target.minMatchScore)n++;else if(void 0!==i.center)if(filters.notAllowed(n))n++;else{if((null==t||null!=t&&t==n)&&void 0!==i.id&&(null==r||null!=r&&i.id==r)&&(!o||keypoints.inBounding(i.center,e))&&matcher.isClosest(n)){a=n;break}n++}else n++;return a},matchClosest:function(e,t=null){if(void 0===e||null==e)return null;let r=null,o=[],a=0;for(let e of tracker.objects)e.score<config.target.minMatchScore?a++:void 0!==e.center&&void 0!==e.center.x&&(null==t||void 0===e.id||e.id==t)?(filters.notAllowed(a)||o.splice(a,0,e.center),a++):a++;if(0==o.length)return null;scores=keypoints.getCenterScores(e,o);let n=matcher.findBestScore(scores);return null!=n&&void 0!==n&&void 0!==tracker.objects[n]&&(r=n),r},isClosest:function(e){let t=[],r=null,o=0;for(let a of tracker.objects)void 0!==a.center?(o==e&&(r=a.center),a.score<config.target.minMatchScore||filters.notAllowed(o)||t.splice(o,0,a.center),o++):o++;if(0==t.length)return!1;let a=keypoints.getCenterScores(r,t),n=matcher.findBestScore(a);return null!=n&&n==e},findBestScore:function(e){let t=null,r=null;for(let o in e)null!=e[o]&&(e[o]<t||null==t)&&(t=e[o],r=o);return r}},patrol={interval:null,resumeTimer:null,paused:!1,active:!1,prevY:0,handle:function(){patrol.start()},cancel:function(){null!=patrol.resumeTimer&&(patrol.pause(),clearTimeout(patrol.resumeTimer),patrol.resumeTimer=null)},resume:function(){null==patrol.resumeTimer&&(patrol.resumeTimer=setTimeout((function(){tracker.dx<0?config.patrol.direction="RIGHT":config.patrol.direction="LEFT",patrol.start(),patrol.update()}),config.patrol.timeout))},update:function(){if(targets.hasTarget())return patrol.pause(),patrol.stop(),tracker.setTargetMode("FOLLOW"),targeting.isControl=!0,targeting.prevTarget=[],targeting.prevNow=[],void(targeting.prevCam=[]);if(patrol.unpause(),patrol.start(),targeting.isControl=!1,tracker.setTargetMode("PATROL"),patrol.isPaused())return void patrol.deactivate();patrol.activate(),null==targeting.target&&targeting.setTargetPoint({x:.5,y:.5});const e=servo.getMinDelta(!0),t=servo.getMaxDelta(!0),r=servo.getMinCoords(!0),o=servo.getMaxCoords(!0);let a=servo.getMaxDelta(!0).x,n=servo.getMinDelta(!0).x;if(config.area.enabled.patrol){let e=config.area.box.patrol,t=area.getMiddleHeight(e,"PATROL");(t<r.y||t>o.y)&&(t=.5),targeting.target.y=t,patrol.prevY!=tracker.dy&&(config.area.world.patrol?(targeting.target.y=t,tracker.dy=.5-targeting.target.y):tracker.dy=.5-targeting.target.y,patrol.prevY=tracker.dy);let i={x1:e.xMin,y1:e.yMin,x2:e.xMin+e.width,y2:e.yMin+e.height},c={x1:.5-i.x1,x2:.5-(i.x1+e.width),y1:.5-i.y1,y2:.5-(i.y1+e.height)};config.area.world.patrol?(a=.5-i.x1,n=.5-i.x2):(i.x1=2*c.x1-tracker.dx,i.x2=2*c.x2-tracker.dx,a=i.x1,n=i.x2)}else targeting.target.y=.5;switch(a<e.x?a=e.x:a>t.x&&(a=t.x),n<e.x?n=e.x:n>t.x&&(n=t.x),n>a&&(tmpLeft=n,tmpRight=a,a=tmpLeft,a=tmpRight),config.patrol.direction){case"RIGHT":tracker.dx>=n&&(targeting.target.x+=config.patrol.step,tracker.dx-=config.patrol.step),tracker.dx<=n&&(targeting.prevTarget=[],tracker.dx=n,patrol.changeDirection());break;case"LEFT":tracker.dx<=a&&(targeting.target.x-=config.patrol.step,tracker.dx+=config.patrol.step),tracker.dx>=a&&(targeting.prevTarget=[],tracker.dx=a,patrol.changeDirection())}},changeDirection:function(){switch(config.patrol.direction){case"LEFT":config.patrol.direction="RIGHT";break;case"RIGHT":config.patrol.direction="LEFT"}},start:function(){null==patrol.interval&&(targeting.cam={x:.5,y:.5},patrol.interval=setInterval((function(){patrol.update()}),config.patrol.interval))},activate:function(){patrol.active=!0},deactivate:function(){patrol.active=!1},pause:function(){patrol.paused=!0},unpause:function(){patrol.paused=!1},stop:function(){null!=patrol.interval&&(clearInterval(patrol.interval),patrol.interval=null)},isPaused:function(){return patrol.paused},isActive:function(){return patrol.active}},render={prevTargetIds:[],append:function(){if(config.render.view){if(tracker.objects&&tracker.objects.length>0)for(let e of tracker.objects.keys())tracker.wrapper.onRender(e,tracker.objects);else keypoints.score=0;config.render.bounds&&(render.drawLockBoundings(),config.area.enabled.target&&render.drawArea("TARGET"),config.area.enabled.patrol&&render.drawArea("PATROL"),config.area.enabled.action&&render.drawArea("ACTION"),config.core.enableDebug&&(render.drawSortBoxes(),render.drawMatchBoxes()))}},clearSimulator:function(){tracker.ctx.setTransform(1,0,0,1,0,0)},drawCrosshair:function(e,t,r,o,a,n,i,c){render.drawLine(0,o,e,o,a,n,i,c),render.drawLine(r,0,r,t,a,n,i,c)},drawBoundings:function(e,t,r=!0){let o=tracker.objects[e].class+" "+e+" - "+Math.round(100*parseFloat(tracker.objects[e].score))+"% ";void 0!==tracker.objects[e].id&&(o+="#"+tracker.objects[e].id),render.drawBoundingBox(tracker.objects[e].box,o,t,r)},drawCenter:function(e,t,r=!0){let o=tracker.objects[e].center.x,a=tracker.objects[e].center.y;render.drawCircle(o,a,0,255,0,.6)},drawSortBoxes:function(){for(let e in sorter.prevBoxes){const t=e+" ("+((new Date).getTime()-sorter.prevBoxes[e].dt.getTime())/1e3+") + x"+sorter.prevBoxes[e].c;render.drawDebugBox(sorter.prevBoxes[e].box,t,"orange","rgba(50, 205, 50, 0.1)")}},drawMatchBoxes:function(){n=0;for(let e in targets.box.last)render.drawDebugBox(e,n,"pink","rgba(50, 5, 150, 0.1)"),n++},drawDebugBox:function(e,t,r,o,a=!0){if(null==e)return;const n=tracker.video.videoWidth,i=tracker.video.videoHeight;let c,l,g,s,d=e.xMin,u=e.yMin;c=n*d,g=i*u,l=n*(d+e.width-d),s=i*(u+e.height-u);const m=parseInt(upscaler.translateX(c)),p=parseInt(upscaler.translateY(g)),f=parseInt(l),b=parseInt(s);tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.strokeStyle=r,tracker.ctx.fillStyle=o,tracker.ctx.fillRect(m,p,f,b),tracker.ctx.rect(m,p,f,b),tracker.ctx.stroke(),tracker.ctx.closePath(),null!=t&&(tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.fillStyle="rgba(0, 0, 0, 0.8)",tracker.ctx.fillRect(m,p-30,f,30),tracker.ctx.strokeStyle="black",tracker.ctx.closePath(),tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.fillStyle="rgba(0, 0, 0, 0.3)",tracker.ctx.strokeStyle="black",tracker.ctx.font="13px Arial",tracker.ctx.fillStyle=r,tracker.ctx.fillText(t,m+10,p-10),tracker.ctx.closePath())},drawBoundingBox:function(e,t,r,o=!0){if(null==e)return;const a=tracker.video.videoWidth,n=tracker.video.videoHeight;let i,c,l,g,s=e.xMin,d=e.yMin;i=a*s,l=n*d,c=a*(s+e.width-s),g=n*(d+e.height-d);const u=parseInt(upscaler.translateX(i)),m=parseInt(upscaler.translateY(l)),p=parseInt(c),f=parseInt(g);tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.strokeStyle="lime",tracker.ctx.fillStyle="rgba(50, 205, 50, 0.1)",tracker.ctx.fillRect(u,m,p,f),tracker.ctx.rect(u,m,p,f),tracker.ctx.stroke(),tracker.ctx.closePath(),null!=t&&(tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.fillStyle="rgba(0, 0, 0, 0.8)",tracker.ctx.fillRect(u,m-30,p,30),tracker.ctx.strokeStyle="black",tracker.ctx.closePath(),tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.fillStyle="rgba(0, 0, 0, 0.3)",tracker.ctx.strokeStyle="black",tracker.ctx.font="13px Arial",tracker.ctx.fillStyle="lime",tracker.ctx.fillText(t,u+10,m-10),tracker.ctx.closePath())},drawArea:function(e){let t={},r="",o="";switch(e){case"TARGET":t=config.area.box.target,r="lime",o="rgba(50, 205, 150, 0.1)";break;case"PATROL":t=config.area.box.patrol,r="orange",o="rgba(255, 255, 0, 0.1)";break;case"ACTION":t=config.area.box.action,r="red",o="rgba(255, 0, 0, 0.1)"}const a=tracker.video.videoWidth,n=tracker.video.videoHeight;let i,c,l,g,s=t.xMin,d=t.yMin;config.render.simulator?config.area.world[e.toLowerCase()]||(s-=tracker.dx,d+=tracker.dy):config.render.locked&&config.area.world[e.toLowerCase()]&&(s-=tracker.dx,d+=tracker.dy),i=a*s,l=n*d,c=a*(s+t.width-s),g=n*(d+t.height-d);const u=parseInt(upscaler.translateX(i)),m=parseInt(upscaler.translateY(l)),p=parseInt(c),f=parseInt(g);tracker.ctx.beginPath(),tracker.ctx.lineWidth=2,tracker.ctx.strokeStyle=r,tracker.ctx.fillStyle=o,tracker.ctx.fillRect(u,m,p,f),tracker.ctx.rect(u,m,p,f),tracker.ctx.stroke(),tracker.ctx.closePath()},drawLockBoundings:function(){targets.box.lock!={xMin:0,yMin:0,width:0,height:0}&&render.drawLockBox(targets.box.lock,null,1)},drawLockBox:function(e,t,r){if(null==e)return;const o=tracker.video.videoWidth,a=tracker.video.videoHeight;let n,i,c,l,g=e.xMin,s=e.yMin;n=o*g,c=a*s,i=o*(g+e.width-g),l=a*(s+e.height-s);const d=parseInt(upscaler.translateX(n)),u=parseInt(upscaler.translateY(c)),m=parseInt(i),p=parseInt(l);tracker.ctx.beginPath(),tracker.ctx.lineWidth=10,tracker.ctx.strokeStyle="red",tracker.ctx.rect(d,u,m,p),tracker.ctx.stroke(),tracker.ctx.closePath()},drawPath:function(e,t,r,o,a,n,i,c){let l=c-.15;l<0&&(l=0),render.drawLine(e,t,r,o,a,n,i,l),render.drawCircle(e,t,a,n,i,l)},drawLine:function(e,t,r,o,a,n,i,c){const l=upscaler.denormalize({x:e,y:t}),g=upscaler.denormalize({x:r,y:o});tracker.ctx.beginPath(),tracker.ctx.lineWidth=config.render.pointWidth,tracker.ctx.strokeStyle="rgba("+a+","+n+","+i+","+c+")",tracker.ctx.moveTo(upscaler.translateX(l.x),upscaler.translateY(l.y)),tracker.ctx.lineTo(upscaler.translateX(g.x),upscaler.translateY(g.y)),tracker.ctx.stroke(),tracker.ctx.closePath()},drawCircle:function(e,t,r,o,a,n){const i=upscaler.denormalize({x:e,y:t});tracker.ctx.beginPath(),tracker.ctx.arc(upscaler.translateX(i.x),upscaler.translateY(i.y),config.render.pointRadius,0,2*Math.PI),tracker.ctx.fillStyle="rgba("+r+","+o+","+a+","+n+")",tracker.ctx.fill(),tracker.ctx.closePath()},drawTargetData:function(){const e=upscaler.getVideoSize();null!=targeting.target&&render.drawCircle(targeting.target.x,targeting.target.y,255,255,255,1),render.drawLine(targeting.cam.x,targeting.cam.y,targeting.now.x,targeting.now.y,255,0,0,.5),render.drawCrosshair(e.width,e.height,targeting.now.x,targeting.now.y,255,0,0,1),render.drawCircle(targeting.now.x,targeting.now.y,200,0,0,1),render.drawCircle(targeting.cam.x,targeting.cam.y,255,255,0,.9)},drawKeypoints3D:function(e){const t=config.model.minScore||0,r=e.map((e=>[e.x,-e.y,-e.z])),o=new ScatterGL.Dataset([...r,...tracker.anchors3D]),a=poseDetection.util.getKeypointIndexBySide(tracker.detectorModel);tracker.scatterGL.setPointColorer((r=>null==e[r]||e[r].score<t?"#ffffff":0===r?"#ff0000":a.left.indexOf(r)>-1?"#00ff00":a.right.indexOf(r)>-1?"#ffa500":void 0)),tracker.scatterGLInitialized?tracker.scatterGL.updateDataset(o):tracker.scatterGL.render(o);const n=poseDetection.util.getAdjacentPairs(tracker.detectorModel).map((e=>({indices:e})));tracker.scatterGL.setSequences(n),tracker.scatterGLInitialized=!0},buildTargetButtons:function(){let e=[];for(let t of tracker.objects)t.score<config.model.minScore||(void 0!==t.id?e.push(t.id):e.push(-1));if(e.sort(),JSON.stringify(render.prevTargetIds)!==JSON.stringify(e)){document.getElementById("targets_list").innerHTML="";for(let t of e){idx=e.indexOf(t),btn=document.createElement("button"),btn.classList.add("btn"),targets.isLocked()&&targets.objIdx==idx?btn.classList.add("btn-danger"):btn.classList.add("btn-secondary"),btn.classList.add("btn_obj_select"),btn.classList.add("btn-sm"),btn.setAttribute("data-obj",t),btn.setAttribute("data-idx",idx),btn.setAttribute("onclick","targets.switchTarget("+idx+");");let r="";void 0!==tracker.objects[idx].class&&(r+=tracker.objects[idx].class+" "),r+=idx,r+=" #"+t,btn.innerHTML=r,document.getElementById("targets_list").appendChild(btn)}}render.prevTargetIds=e},updateTargetButtons:function(){$(".btn_obj_select").removeClass("btn-primary"),$(".btn_obj_select").addClass("btn-secondary"),targets.isLocked()?($(".btn_obj_select").removeClass("btn-danger"),$(".btn_obj_select").addClass("btn-secondary"),$('.btn_obj_select[data-idx="'+targets.tmpObjIdx+'"]').removeClass("btn-secondary"),$('.btn_obj_select[data-idx="'+targets.tmpObjIdx+'"]').addClass("btn-danger")):($(".btn_obj_select").removeClass("btn-danger"),$(".btn_obj_select").addClass("btn-secondary")),targets.isLost()&&!targets.isLocked()?$("#lock-lost-counter").show():$("#lock-lost-counter").hide(),$('.btn_obj_select[data-idx="'+targets.tmpObjIdx+'"]').addClass("btn-primary"),$('.btn_obj_select[data-idx="'+targets.tmpObjIdx+'"]').removeClass("btn-secondary")},showPlaybackControls:function(){let e=tracker.canvas.height/2*.5;tracker.ctx.fillStyle="black",tracker.ctx.globalAlpha=.5,tracker.ctx.fillRect(0,0,tracker.canvas.width,tracker.canvas.height),tracker.ctx.fillStyle="#DDD",tracker.ctx.globalAlpha=.75,tracker.ctx.beginPath(),tracker.ctx.moveTo(tracker.canvas.width/2+e/2,tracker.canvas.height/2),tracker.ctx.lineTo(tracker.canvas.width/2-e/2,tracker.canvas.height/2+e),tracker.ctx.lineTo(tracker.canvas.width/2-e/2,tracker.canvas.height/2-e),tracker.ctx.closePath(),tracker.ctx.fill(),tracker.ctx.globalAlpha=1}},serial={port:null,textEncoder:null,writableStreamClosed:null,writer:null,enabled:!1,connect:async function(e=!1){try{serial.port=await navigator.serial.requestPort(),await serial.port.open({baudRate:config.serial.baudRate});let t={};"true"==localStorage.dtrOn&&(t.dataTerminalReady=!0),"true"==localStorage.rtsOn&&(t.requestToSend=!0),Object.keys(t).length>0&&await serial.port.setSignals(t),serial.textEncoder=new TextEncoderStream,serial.writableStreamClosed=serial.textEncoder.readable.pipeTo(serial.port.writable),serial.writer=serial.textEncoder.writable.getWriter(),serial.enabled=!0,e&&ui.enableBtn("btn-servo",null,"success"),await serial.listen()}catch(e){tracker.dispatch("serialDisconnect",e),console.error(e),serial.enabled=!1,servo.disable(),ui.disableBtn("btn-usb-connect",null),ui.disableBtn("btn-servo",null),alert("USB Serial Connection Failed: "+e)}},send:async function(e){serial.enabled?(tracker.dispatch("serialSend",e),console.log(e),await serial.writer.write(e)):console.error("Serial port is disabled. Abort sending...")},listen:async function(){const e=new TextDecoderStream;serial.port.readable.pipeTo(e.writable);for(;serial.port.readable;){const t=e.readable.getReader();ui.disableBtn("btn-usb-connect",null,!1),ui.enableBtn("btn-usb-connect",null,"success"),serial.enabled=!0,tracker.dispatch("serialConnect",serial.port),servo.enabled&&(ui.disableBtn("btn-servo",null,!1),ui.enableBtn("btn-servo",null,"success"));try{for(;;){const{value:e,done:r}=await t.read();serial.onReceive(e)}}catch(e){console.error("LISTEN",e)}finally{t.releaseLock()}}},onReceive:function(e){switch(tracker.dispatch("serialReceive",e),config.command.serial.format){case"RAW":tracker.remoteStatus.local=e;break;case"JSON":try{tracker.remoteStatus.local=JSON.parse(e)}catch(e){console.error("JSON parse error",e)}}console.log(e)}},servo={enabled:!1,enable:function(){servo.enabled=!0},disable:async function(){servo.enabled=!1,ui.disableBtn("btn-servo")},isEnabled:function(){return servo.enabled},getMinCoords:function(e=!1){return"video"==app.source||0==config.servo.map_fov?{x:0,y:0}:1==config.servo.use_limit||1==e?{x:0-(config.servo.maxLimit.x/config.camera.fov.x-1)/2,y:0-(config.servo.maxLimit.x/config.camera.fov.x-1)/2}:{x:0-(config.servo.maxAngle.x/config.camera.fov.x-1)/2,y:0-(config.servo.maxAngle.x/config.camera.fov.x-1)/2}},getMaxCoords:function(e=!1){return"video"==app.source||0==config.servo.map_fov?{x:1,y:1}:1==config.servo.use_limit||1==e?{x:1+(config.servo.maxLimit.x/config.camera.fov.x-1)/2,y:1+(config.servo.maxLimit.x/config.camera.fov.x-1)/2}:{x:1+(config.servo.maxAngle.x/config.camera.fov.x-1)/2,y:1+(config.servo.maxAngle.x/config.camera.fov.x-1)/2}},getMinDelta:function(e=!1){return"video"==app.source||0==config.servo.map_fov?{x:-.5,y:-.5}:1==config.servo.use_limit||1==e?{x:-config.servo.maxLimit.x/config.camera.fov.x/2,y:-config.servo.maxLimit.y/config.camera.fov.y/2}:{x:-config.servo.maxAngle.x/config.camera.fov.x/2,y:-config.servo.maxAngle.y/config.camera.fov.y/2}},getMaxDelta:function(e=!1){return"video"==app.source||0==config.servo.map_fov?{x:.5,y:.5}:1==config.servo.use_limit||1==e?{x:config.servo.maxLimit.x/config.camera.fov.x/2-config.servo.minLimit.x/config.camera.fov.x,y:config.servo.maxLimit.y/config.camera.fov.y/2-config.servo.minLimit.y/config.camera.fov.y}:{x:config.servo.maxAngle.x/config.camera.fov.x/2,y:config.servo.maxAngle.y/config.camera.fov.y/2}},deltaToAngle:function(e=null){return null==e&&(e={x:tracker.dx,y:tracker.dy}),"video"==app.source||0==config.servo.map_fov?{x:Math.round(parseFloat(e.x*config.servo.maxAngle.x),0),y:Math.round(parseFloat(e.y*config.servo.maxAngle.y),0)}:{x:Math.round(parseFloat(e.x*config.camera.fov.x)/config.servo.angleMultiplier.x,0),y:Math.round(parseFloat(e.y*config.camera.fov.y)/config.servo.angleMultiplier.y,0)}},pointToAngle:function(e){return"video"==app.source||0==config.servo.map_fov?{x:Math.round(parseFloat((.5-e.x)*config.servo.maxAngle.x),0),y:Math.round(parseFloat((.5-e.y)*config.servo.maxAngle.y),0)}:{x:Math.round(parseFloat((.5-e.x)*config.camera.fov.x/config.servo.angleMultiplier.x),0),y:Math.round(parseFloat((.5-e.y)*config.camera.fov.y/config.servo.angleMultiplier.y),0)}}},shortcuts={assign:function(){document.addEventListener("keyup",(e=>{if(!$("#video_src").is(":focus"))switch("MANUAL"!=config.target.mode&&"MOUSE"!=config.target.mode||" "!=e.key&&"Space"!=e.code&&32!=e.keyCode||app.toggleAction(),e.key){case"d":app.toggleDebug();break;case"e":app.toggleConsole();break;case"q":app.toggleSwitchtarget("PREV");break;case"w":app.toggleSwitchtarget("NEXT");break;case"1":app.toggleTargetPoint("AUTO");break;case"2":app.toggleTargetPoint("HEAD");break;case"3":app.toggleTargetPoint("NECK");break;case"4":app.toggleTargetPoint("BODY");break;case"5":app.toggleTargetPoint("LEGS");break;case"x":app.toggleServoHorizontal();break;case"y":app.toggleServoVertical();break;case"b":app.toggleBounds();break;case"c":app.toggleCenter();break;case"v":app.toggleCenterLock();break;case"i":app.toggleSimulator();break;case"u":app.toggleSerial();break;case"s":app.toggleServo();break;case"a":app.toggleActionMode();break;case"l":app.toggleTargetLock();break;case"z":app.toggleSingleTarget();break;case"o":"MANUAL"!=config.target.mode&&"MOUSE"!=config.target.mode||app.toggleActionSwitch();break;case"p":app.toggleControlMode("IDLE");break;case"f":app.toggleControlMode("FOLLOW");break;case"r":app.toggleControlMode("PATROL");break;case"n":app.toggleControlMode("MANUAL");break;case"m":app.toggleControlMode("MOUSE")}}))}},sorter={prevBoxes:{},mapping:{},prevMapping:{},maxId:0,boxMaxAge:5,addPrevBox:function(e){let t=sorter.maxId+1;for(;void 0!==sorter.prevBoxes[t];)t++;null!=tracker.objects[e].box.xMin&&0!=tracker.objects[e].box.width&&(sorter.prevBoxes[t]={box:tracker.objects[e].box,dt:new Date,c:0},sorter.mapBox(t,e),sorter.maxId=t)},mapBox:function(e,t){sorter.mapping[e]=t,e>sorter.maxId&&(sorter.maxId=e)},getClosestBound:function(e){return id=null,scores=keypoints.getBoundingScoresDict(tracker.objects[e].center,sorter.prevBoxes),scores.length>0&&(id=Object.keys(scores).reduce((function(e,t){return scores[e]<scores[t]?e:t}))),null!=id&&id<0&&(id=null),id},byPrevBox:function(e){tmpId=sorter.getClosestBound(e),null!=tmpId?null!=tracker.objects[e].box.xMin&&0!=tracker.objects[e].box.width&&(c=sorter.prevBoxes[tmpId].c+1,sorter.prevBoxes[tmpId]={box:tracker.objects[e].box,dt:new Date,c:c},sorter.mapBox(tmpId,e)):sorter.addPrevBox(e)},sortByBounds:function(){for(let e of tracker.objects.keys())void 0!==tracker.objects[e].center&&void 0!==tracker.objects[e].box&&(tracker.objects[e].score<.2||sorter.byPrevBox(e))},sortByX:function(){tracker.objects.sort((function(e,t){return e.center.x<t.center.x?-1:e.center.x>t.center.x?1:0}))},clearExpired:function(){for(id in sorter.prevBoxes)r=((new Date).getTime()-sorter.prevBoxes[id].dt.getTime())/1e3,r>sorter.boxMaxAge&&delete sorter.prevBoxes[id]},clear:function(){sorter.clearExpired()},clean:function(){for(let e of tracker.objects.keys()){let t=tracker.objects[e].id;if(void 0!==sorter.prevMapping[t]&&sorter.prevMapping[t]==e)for(let r in sorter.mapping)oldIdx=sorter.mapping[r],oldIdx==e&&r!=t&&delete sorter.mapping[r]}},append:function(){sorter.maxId=0,sorter.sortByX();for(let e of tracker.objects.keys())tracker.objects[e].id=e;sorter.sortByBounds();for(let e in sorter.mapping)idx=sorter.mapping[e],void 0!==tracker.objects[idx]&&(tracker.objects[idx].id=e);sorter.prevMapping=sorter.mapping,sorter.clear(),(sorter.maxId>100||Object.keys(sorter.prevBoxes).length>100)&&(sorter.maxId=0,sorter.prevBoxes={},sorter.mapping={},sorter.prevMapping={})}},camera={stream:null,isList:!1,getDevices:function(e){const t=document.getElementById("camera_select");t.innerHTML="";let r=document.createElement("option");r.value="";let o="--SELECT CAMERA--",a=document.createTextNode(o);r.appendChild(a),t.appendChild(r);let n=1;e.forEach((e=>{"videoinput"===e.kind&&(r=document.createElement("option"),r.value=e.deviceId,o=e.label||"Camera "+n++,a=document.createTextNode(o),r.appendChild(a),t.appendChild(r))})),camera.isList=!0},stop:function(e){e.getTracks().forEach((e=>{e.stop()}))},init:async function(){tracker.init(),config.init.mode="camera";try{camera.onReady()}catch(e){tracker.dispatch("videoerror",e),console.error(e)}},selectDevice:async function(e){camera.isList||navigator.mediaDevices.enumerateDevices().then(camera.getDevices),config.camera.deviceId=e,null!=camera.stream&&camera.stop(camera.stream);try{window.cancelAnimationFrame(tracker.reqID),tracker.reqID=null,camera.onReady()}catch(e){tracker.dispatch("videoerror",e),console.error(e)}},setup:async function(){if(tracker.setStatus("Please wait...initializing camera..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw alert("Browser API navigator.mediaDevices.getUserMedia not available"),new Error("Browser API navigator.mediaDevices.getUserMedia not available");null!=config.camera.deviceId&&camera.isList||navigator.mediaDevices.enumerateDevices().then(camera.getDevices);let e={audio:!1,video:{width:{ideal:config.camera.resolution.x},height:{ideal:config.camera.resolution.y}}};return null!=config.camera.deviceId&&(e.video.deviceId={exact:config.camera.deviceId}),camera.stream=await navigator.mediaDevices.getUserMedia(e),tracker.video.srcObject=camera.stream,tracker.video.width=camera.stream.getVideoTracks()[0].getSettings().width,tracker.video.height=camera.stream.getVideoTracks()[0].getSettings().height,tracker.started=!1,new Promise((e=>{tracker.video.onloadedmetadata=()=>e(tracker.video)}))},onReady:async function(){null!=tracker.wrapper&&tracker.wrapper.onReady(),tracker.video=await camera.setup(),tracker.video.play(),camera.frame(),tracker.ready=!0,"INTERVAL"==config.core.update_method&&setInterval((()=>{tracker.ready&&tracker.detect()}),1e3/config.core.update_fps)},frame:async function(){if(tracker.setStatus(""),tracker.video.readyState===tracker.video.HAVE_ENOUGH_DATA&&("RAF"==config.core.update_method&&tracker.detect(),null!=config.camera.deviceId&&camera.isList&&$("#camera_select").val(config.camera.deviceId),tracker.clearCanvas(),config.core.enableVideo&&config.render.view)){let e=tracker.video.videoWidth,t=tracker.video.videoHeight,r=0,o=0;const a=upscaler.fit(),n=(upscaler.getVideoSize(),upscaler.getCanvasSize());if(config.render.simulator){const e=upscaler.denormalize({x:tracker.dx,y:tracker.dy});r=e.x,o=e.y}tracker.canvas.width=tracker.video.videoWidth,tracker.canvas.height=tracker.video.videoHeight,tracker.sourceCanvas.width=tracker.video.videoWidth,tracker.sourceCanvas.height=tracker.video.videoHeight,config.render.resize&&(e=a.width,t=a.height,r+=(n.width-a.width)/2),tracker.sourceCtx.drawImage(tracker.video,r,o,e,t),tracker.ctx.drawImage(tracker.video,r,o,e,t),tracker.started=!0}tracker.handle(),tracker.reqID=window.requestAnimationFrame(camera.frame)}},remote={started:!1,path:"",isConnection:!1,appendToken:function(){if(""!=config.security.webToken&&null!=config.security.webToken)return"?token="+config.security.webToken},init:async function(){tracker.init(),config.init.mode="remote",""!=app.sourceRemote&&(tracker.video.autoPlay=!0,tracker.video.loop=!0,tracker.ready=!0,tracker.started=!1,tracker.video=document.getElementById("remote"),await remote.onReady())},onReady:async function(e){tracker.log("On Video ready"),null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),null!=tracker.wrapper&&await tracker.wrapper.onReady(),tracker.video.width=640,tracker.video.height=480,tracker.video.videoWidth=640,tracker.video.videoHeight=480,tracker.canvas.width=640,tracker.canvas.height=480,tracker.ready=!0,tracker.started=!1,"INTERVAL"==config.core.update_method&&setInterval((()=>{tracker.ready&&tracker.detect()}),1e3/config.core.update_fps),remote.frame()},load:async function(e){e+=remote.appendToken(),console.log(e),tracker.log("Loading source: "+e);try{var t=new XMLHttpRequest;t.open("HEAD",e,!1),t.send(),200==t.status&&(remote.isConnection=!0)}catch(e){return console.error(e),void alert("Invalid address or connection problem!")}$("#remote").attr("src",e),$("#video source").attr("src",e),null!=tracker.wrapper&&tracker.wrapper.onLoad(),tracker.isPlaying=!1,null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),tracker.video.src=e;try{await remote.init(),remote.frame(),tracker.ready=!0,tracker.started=!1}catch(e){alert("Invalid address or connection problem!"),console.error(e)}},frame:async function(){if(tracker.setStatus(""),tracker.ready){if("RAF"==config.core.update_method&&tracker.started&&tracker.detect(),tracker.clearCanvas(),config.core.enableVideo&&config.render.view){let e=tracker.video.videoWidth,t=tracker.video.videoHeight,r=0,o=0,a=upscaler.fit(),n=(upscaler.getVideoSize(),upscaler.getCanvasSize());if(config.render.simulator){const e=upscaler.denormalize({x:tracker.dx,y:tracker.dy});r=e.x,o=e.y}config.render.resize?(e=a.width,t=a.height,r+=(n.width-a.width)/2):(tracker.canvas.width=tracker.video.videoWidth,tracker.canvas.height=tracker.video.videoHeight);try{tracker.sourceCtx&&null!=tracker.video&&(tracker.sourceCtx.drawImage(tracker.video,r,o,e,t),tracker.ctx.drawImage(tracker.video,r,o,e,t),tracker.started=!0)}catch(e){console.error(e)}}tracker.started&&tracker.handle()}tracker.reqID=window.requestAnimationFrame(remote.frame)},playPauseClick:function(){tracker.ready&&(tracker.video.paused?(tracker.log("click: Play"),tracker.video.play(),tracker.isWaiting=!0,tracker.setStatus("Please wait...")):tracker.isWaiting||(tracker.log("click: Pause"),tracker.video.pause(),tracker.setStatus("Paused.")))}},stream={init:function(){tracker.init(),config.init.mode="stream",tracker.videoJS=videojs("video"),tracker.video=document.querySelector("video#video, #video video"),tracker.video.autoPlay=!1,tracker.video.loop=!0,tracker.ready=!0,tracker.video.addEventListener("loadedmetadata",(function(){tracker.log("Event: loadedmetadata"),tracker.ready=!0,render.showPlaybackControls()}),!1),tracker.video.addEventListener("playing",(function(){tracker.log("Event: playing"),tracker.isWaiting=!1,stream.onReady()}),!1),tracker.video.addEventListener("play",(function(){tracker.log("Event: play")}),!1),tracker.video.addEventListener("error",(function(e){console.error(e),tracker.dispatch("videoerror",e),tracker.setStatus("Error")}),!0),tracker.canvas.addEventListener("click",(function(){video.playPauseClick()}))},load:function(e){tracker.log("Loading source: "+e),tracker.setStatus("Please wait...loading..."),null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),null!=tracker.wrapper&&tracker.wrapper.onLoad(),tracker.video.pause(),tracker.videoJS.src({src:e,type:"application/x-mpegURL"}),tracker.ready=!0,tracker.videoJS.play()},onReady:async function(e){tracker.log("On Stream ready"),null!=tracker.wrapper&&tracker.wrapper.onReady(),tracker.video.width=tracker.video.videoWidth,tracker.video.height=tracker.video.videoHeight,tracker.canvas.width=tracker.video.videoWidth,tracker.canvas.height=tracker.video.videoHeight,null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),tracker.reqID=window.requestAnimationFrame(video.frame)}},video={started:!1,init:async function(){tracker.init(),config.init.mode="video",tracker.video.autoPlay=!0,tracker.video.loop=!0,tracker.ready=!0,tracker.video.addEventListener("loadedmetadata",(function(){tracker.log("Event: loadedmetadata"),tracker.ready=!0,render.showPlaybackControls()}),!1),tracker.video.addEventListener("playing",(function(){tracker.log("Event: playing"),tracker.isWaiting=!1,tracker.isPlaying||(video.onReady(),tracker.isPlaying=!0)}),!1),tracker.video.addEventListener("play",(function(){tracker.log("Event: play")}),!1),tracker.video.addEventListener("error",(function(e){console.error(e),tracker.dispatch("videoerror",e),tracker.setStatus("Error")}),!0),tracker.canvas.addEventListener("click",(function(){video.started||video.playPauseClick(),video.started=!0}))},onReady:async function(e){tracker.log("On Video ready"),null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),null!=tracker.wrapper&&await tracker.wrapper.onReady(),tracker.video.width=tracker.video.videoWidth,tracker.video.height=tracker.video.videoHeight,tracker.canvas.width=tracker.video.videoWidth,tracker.canvas.height=tracker.video.videoHeight,tracker.ready=!0,tracker.started=!1,tracker.reqID=window.requestAnimationFrame(video.frame),"INTERVAL"==config.core.update_method&&setInterval((()=>{tracker.ready&&tracker.detect()}),1e3/config.core.update_fps)},load:async function(e){tracker.log("Loading source: "+e),tracker.setStatus("Please wait...loading..."),tracker.isPlaying=!1,null!=tracker.reqID&&window.cancelAnimationFrame(tracker.reqID),null!=tracker.wrapper&&tracker.wrapper.onLoad(),tracker.started=!1,tracker.video.pause(),tracker.video.src=e,tracker.ready=!0,tracker.video.play()},frame:async function(){if(tracker.setStatus(""),tracker.ready){if("RAF"==config.core.update_method&&tracker.detect(),tracker.clearCanvas(),config.core.enableVideo&&config.render.view){let e=tracker.video.videoWidth,t=tracker.video.videoHeight,r=0,o=0;const a=upscaler.fit(),n=(upscaler.getVideoSize(),upscaler.getCanvasSize());if(config.render.simulator){const e=upscaler.denormalize({x:tracker.dx,y:tracker.dy});r=e.x,o=e.y}tracker.sourceCanvas.width=tracker.video.videoWidth,tracker.sourceCanvas.height=tracker.video.videoHeight,config.render.resize?(e=a.width,t=a.height,r+=(n.width-a.width)/2):(tracker.canvas.width=tracker.video.videoWidth,tracker.canvas.height=tracker.video.videoHeight),tracker.sourceCtx.drawImage(tracker.video,r,o,e,t),tracker.ctx.drawImage(tracker.video,r,o,e,t),tracker.started=!0}tracker.handle()}tracker.reqID=window.requestAnimationFrame(video.frame)},playPauseClick:function(){tracker.ready&&(tracker.video.paused?(tracker.log("click: Play"),tracker.video.play(),tracker.isWaiting=!0,tracker.setStatus("Please wait...")):tracker.isWaiting||(tracker.log("click: Pause"),tracker.video.pause(),tracker.setStatus("Paused.")))}},storage={setLocalStorage:function(e,t){"undefined"!=typeof localStorage&&localStorage.setItem(e,t)},getLocalStorage:function(e){if("undefined"!=typeof localStorage)return localStorage.getItem(e)},removeLocalStorage:function(e){"undefined"!=typeof localStorage&&localStorage.removeItem(e)},isLocalStorage:function(e){if("undefined"!=typeof localStorage&&null!==localStorage.getItem(e))return!0},saveConfig:function(){const e={};e.version=app.version,e.time=Date.now(),e.data={init:config.init,core:config.core,target:config.target,patrol:config.patrol,action:config.action,manual:config.manual,render:config.render,camera:config.camera,servo:config.servo,area:config.area,panel:config.panel},storage.setLocalStorage("config",JSON.stringify(e)),alert("Config saved.")},resetConfig:function(){storage.isLocalStorage("config")&&(storage.removeLocalStorage("config"),window.location.reload())},loadConfig:function(){if(storage.isLocalStorage("config")){const e=JSON.parse(storage.getLocalStorage("config"));void 0!==e.data.init&&(config.init=e.data.init),void 0!==e.data.core&&(config.core=e.data.core),void 0!==e.data.target&&(config.target=e.data.target),void 0!==e.data.patrol&&(config.patrol=e.data.patrol),void 0!==e.data.action&&(config.action=e.data.action),void 0!==e.data.manual&&(config.manual=e.data.manual),void 0!==e.data.render&&(config.render=e.data.render),void 0!==e.data.camera&&(config.camera=e.data.camera),void 0!==e.data.servo&&(config.servo=e.data.servo),void 0!==e.data.area&&(config.area=e.data.area),void 0!==e.data.panel&&(config.panel=e.data.panel)}""!=config.init.modelName&&app.model!=config.init.modelName&&(app.model=config.init.modelName)}},targeting={initialized:!1,started:!1,isControl:!0,distNT:{x:0,y:0},percNT:{x:0,y:0},distCN:{x:0,y:0},percCN:{x:0,y:0},move:{up:!1,down:!1,left:!1,right:!1},speed:{x:0,y:0},th:{x:0,y:0},power:{x:0,y:0},target:null,now:{x:.5,y:.5},cam:{x:.5,y:.5},prevTarget:[],prevNow:[],prevCam:[],beforeTarget:null,init:function(){targeting.prevCommand={x:config.servo.initAngle.x,y:config.servo.initAngle.y},targeting.nextCommand={x:config.servo.initAngle.x,y:config.servo.initAngle.y}},update:function(){targeting.initialized||(targeting.init(),targeting.initialized=!0),0==tracker.objects.length||1==tracker.objects.length&&(keypoints.score,config.model.minScore),targeting.prepare();const e=targets.choose();switch(("MANUAL"!=config.target.mode&&"MOUSE"!=config.target.mode||"TARGET"!=config.manual.mode)&&targeting.hasControl()&&(targets.hasTarget()?targeting.target=targets.getTargetPoint(config.target.point,e):targeting.target=null),null==targeting.target&&(targeting.target=targeting.beforeTarget),null!=targeting.target?!config.area.enabled.target||area.inArea(targeting.target,"TARGET")?(targeting.beforeTarget=targeting.target,targeting.preparePosition()):targeting.target=null:targeting.hasControl()&&"FOLLOW"==config.target.mode&&config.target.brake&&null!=targeting.beforeTarget&&(config.area.enabled.target&&!area.inArea(targeting.cam,"TARGET")||(targeting.now=targeting.cam)),targeting.preparePower(),null!=targeting.target&&targeting.updatePosition(),targeting.prepareMovement(),targeting.initMovement(),targeting.handlePrev(),targeting.smoothCoords(),config.target.mode){case"IDLE":break;case"PATROL":targeting.setControl(!1),patrol.handle(),config.render.locked||targeting.setMovement();break;case"FOLLOW":targeting.setControl(!0),targeting.setMovement(),patrol.isPaused()&&(targets.hasTarget()?patrol.cancel():patrol.resume());break;case"MANUAL":manual.keyControl();break;case"MOUSE":manual.mouseControl()}targeting.hasControl()?target.handle():action.isActive()&&action.stop(),targeting.transformMovement(),config.render.view&&render.drawTargetData()},prepare:function(){config.render.locked?(targeting.cam.x=.5,targeting.cam.y=.5):(targeting.cam.x=.5-tracker.dx,targeting.cam.y=.5-tracker.dy),targeting.started||(targeting.now.x=.5,targeting.now.y=.5,targeting.started=!0)},preparePosition:function(){targeting.distNT.x=Math.abs(targeting.now.x-targeting.target.x),targeting.distNT.y=Math.abs(targeting.now.y-targeting.target.y),targeting.percNT.x=100*targeting.distNT.x,targeting.percNT.y=100*targeting.distNT.y,isNaN(targeting.percNT.x)&&(targeting.percNT.x=0),isNaN(targeting.percNT.y)&&(targeting.percNT.y=0)},preparePower:function(){targeting.power.x=targeting.percNT.x*config.target.delayMultiplier/100,targeting.power.y=targeting.percNT.y*config.target.delayMultiplier/100,isNaN(targeting.power.x)&&(targeting.power.x=0),isNaN(targeting.power.y)&&(targeting.power.y=0)},updatePosition:function(){("MANUAL"!=config.target.mode&&"MOUSE"!=config.target.mode||"NOW"!=config.manual.mode)&&(config.target.smoothFollow?(targeting.target.x>targeting.now.x?targeting.now.x+=targeting.power.x:targeting.target.x<targeting.now.x&&(targeting.now.x-=targeting.power.x),targeting.target.y>targeting.now.y?targeting.now.y+=targeting.power.y:targeting.target.y<targeting.now.y&&(targeting.now.y-=targeting.power.y)):(targeting.now.x=targeting.target.x,targeting.now.y=targeting.target.y));const e=servo.getMaxCoords(!0),t=servo.getMinCoords(!0);targeting.hasControl()&&(targeting.now.x>e.x&&(targeting.now.x=e.x),targeting.now.x<t.x&&(targeting.now.x=t.x),targeting.now.y>e.y&&(targeting.now.y=e.y),targeting.now.y<t.y&&(targeting.now.y=t.y))},prepareMovement:function(){targeting.distCN.x=Math.abs(targeting.cam.x-targeting.now.x),targeting.distCN.y=Math.abs(targeting.cam.y-targeting.now.y),targeting.percCN.x=100*targeting.distCN.x,targeting.percCN.y=100*targeting.distCN.y,targeting.speed.x=targeting.percCN.x*config.target.speedMultiplier/100,targeting.speed.y=targeting.percCN.y*config.target.speedMultiplier/100,targeting.th.x=targeting.speed.x*config.target.smoothMultiplier,targeting.th.y=targeting.speed.y*config.target.smoothMultiplier},initMovement:function(){targeting.move.up=!1,targeting.move.down=!1,targeting.move.left=!1,targeting.move.right=!1},setMovement:function(){targeting.now.x<targeting.cam.x-targeting.th.x?targeting.move.left=!0:targeting.now.x>targeting.cam.x+targeting.th.x&&(targeting.move.right=!0),targeting.now.y<targeting.cam.y-targeting.th.y?targeting.move.up=!0:targeting.now.y>targeting.cam.y+targeting.th.y&&(targeting.move.down=!0)},transformMovement:function(){if(targeting.hasControl()&&!targets.hasTarget())return;const e=servo.getMinDelta(!0),t=servo.getMaxDelta(!0);config.target.smoothCamera?(targeting.move.left&&tracker.dx<=t.x&&(tracker.dx+=targeting.speed.x),targeting.move.right&&tracker.dx>=e.x&&(tracker.dx-=targeting.speed.x),targeting.move.up&&tracker.dy<=t.y&&(tracker.dy+=targeting.speed.y),targeting.move.down&&tracker.dy>=e.y&&(tracker.dy-=targeting.speed.y)):(targeting.move.left&&tracker.dx<=t.x&&(tracker.dx=.5-targeting.now.x),targeting.move.right&&tracker.dx>=e.x&&(tracker.dx=.5-targeting.now.x),targeting.move.up&&tracker.dy<=t.y&&(tracker.dy=.5-targeting.now.y),targeting.move.down&&tracker.dy>=e.y&&(tracker.dy=.5-targeting.now.y))},hasTargetPoint:function(){return null!=targeting.target},hasControl:function(){return targeting.isControl},setControl:function(e=!0){targeting.isControl=e},setTargetPoint:function(e){targeting.target=e},smoothCoords:function(){targeting.isControl&&(config.target.mean.target&&null!=targeting.target&&(targeting.target=keypoints.calculateMeanCoordinate(targeting.prevTarget)),config.target.mean.now&&null!=targeting.now&&(targeting.now=keypoints.calculateMeanCoordinate(targeting.prevNow)),config.target.mean.camera&&null!=targeting.cam&&(targeting.cam=keypoints.calculateMeanCoordinate(targeting.prevCam)))},handlePrev:function(){null!=targeting.target&&(targeting.prevTarget=targeting.storePrev(targeting.target,targeting.prevTarget,config.target.meanStep.target,config.target.meanDepth.target)),null!=targeting.now&&(targeting.prevNow=targeting.storePrev(targeting.now,targeting.prevNow,config.target.meanStep.now,config.target.meanDepth.now)),null!=targeting.cam&&(targeting.prevCam=targeting.storePrev(targeting.cam,targeting.prevCam,config.target.meanStep.camera,config.target.meanDepth.camera))},storePrev:function(e,t,r,o){return null!=t&&t.length>0&&keypoints.getCoordDistance(t[0],e)<r||(t.unshift(e),t.length>o&&t.pop()),t},center:function(){targeting.target=null,targeting.now={x:.5,y:.5},targeting.cam={x:.5,y:.5},targeting.prevTarget=[],targeting.prevNow=[],targeting.prevCam=[],targeting.beforeTarget=null,tracker.dx=0,tracker.dy=0}},target={counter:{on:0,leave:0},interval:{leave:null},checkIntervalTime:50,maxOnTargetCounter:999,handle:function(){let e=!1,t=targets.objIdx;tracker.countDetected()>0&&void 0!==tracker.objects[t]&&tracker.objects[t].score>=config.target.detectMinScore&&(keypoints.inBounding(targeting.cam,tracker.objects[t].box)||targeting.distCN.x<=config.target.threshold&&targeting.distCN.y<=config.target.threshold)?(e=!0,target.counter.on++,target.counter.on>target.maxOnTargetCounter&&(target.counter.on=target.maxOnTargetCounter)):target.counter.on=0,(e&&target.counter.on<config.target.minTime||!targets.hasTarget())&&(e=!1),e?(!config.area.enabled.action||area.inArea(targeting.cam,"ACTION")?(action.isEnabled()&&!action.isActive()&&target.counter.on>=config.action.timeout.start&&action.start(),action.isActive()&&action.update()):action.isActive()&&action.stop(),ui.statusAlert("target-lost",!1),ui.statusAlert("target-locked",!0,config.LANG.TARGET.ON_TARGET+" ("+target.counter.on+")"),!targets.isLocked()&&targets.isLost()&&(targets.lock(!1),targets.lost=!1)):(action.isActive()&&action.stop(),!targets.isLocked()||!targets.isLost()&&targets.matched||targets.lock(!1),ui.statusAlert("target-locked",!1))},check:function(){!targets.isLocked()||targets.hasTarget()||targets.search||null==target.interval.leave&&(target.counter.leave=0,target.interval.leave=setInterval((function(){target.onLost()}),target.checkIntervalTime))},onLost:function(){null!=targets.box.lock&&(target.counter.leave++,targets.search=!0,config.target.single||targets.resizeBoundings(),ui.statusAlert("target-lost",!1),ui.statusAlert("target-searching",!0,config.LANG.TARGET.SEARCHING+" "+(config.target.lostTime-target.counter.leave)),target.counter.leave>config.target.lostTime&&(config.target.single?(target.clr(),targets.unlock()):void 0!==tracker.objects[targets.tmpObjIdx]?(targets.box.lock=tracker.objects[targets.tmpObjIdx].box,targets.objIdx=targets.tmpObjIdx,targets.resetBoundings(),target.clr(),targets.unlock()):(target.clr(),targets.unlock()),targets.isLocked()||(targets.lost=!0)))},clr:function(){null!=target.interval.leave&&(clearInterval(target.interval.leave),target.interval.leave=null,target.counter.leave=0,targets.lost=!0,targets.search=!1,ui.statusAlert("target-searching",!1,""))}},targets={objIdx:0,tmpObjIdx:0,identifier:-1,tmpIdentifier:-1,changeIdx:null,box:{last:[],lock:{xMin:0,yMin:0,width:0,height:0},current:{xMin:0,yMin:0,width:0,height:0}},center:{last:{x:0,y:0},current:{x:0,y:0}},matchType:"",lost:!1,search:!1,matched:!1,isTarget:!1,choose:function(){render.buildTargetButtons(),targets.handleSwitch();let e=finder.find();return targets.matched=void 0!==e&&null!=e,targets.assign(e),render.updateTargetButtons(),targets.isTarget=targets.matched,targets.hasTarget()&&(targets.objIdx=e,targets.tmpObjIdx=targets.objIdx),target.check(),targets.isLocked()&&!targets.hasTarget()||target.clr(),null==e||void 0===tracker.objects[e]?null:(void 0!==tracker.objects[e].id&&(targets.identifier=tracker.objects[e].id,targets.tmpIdentifier=targets.identifier),targets.objIdx)},assign:function(e){if(null!=e){void 0!==tracker.objects[e]&&null!=tracker.objects[e].center.x&&(targets.center.last=tracker.objects[e].center,targets.center.current=targets.center.last,targets.box.current=tracker.objects[e].box,targets.isLocked()&&(targets.box.lock=targets.box.current),void 0!==tracker.objects[e].id&&(targets.identifier=tracker.objects[e].id,targets.tmpIdentifier=targets.identifier));for(let e in targets.box.last)void 0===tracker.objects[e]&&(targets.box.last[e]=null);for(let e in tracker.objects)void 0!==tracker.objects[e].box&&(targets.box.last[e]=tracker.objects[e].box)}},handleSwitch:function(){null!=targets.changeIdx&&(targets.objIdx=targets.changeIdx,targets.tmpObjIdx=targets.objIdx,void 0!==tracker.objects[targets.objIdx]&&(targets.center.last=tracker.objects[targets.objIdx].center,void 0!==tracker.objects[targets.objIdx].id&&(targets.identifier=tracker.objects[targets.objIdx].id),targets.isLocked()&&(targets.box.lock=tracker.objects[targets.objIdx].box)),targets.changeIdx=null)},switchTarget:function(e){targets.objIdx=parseInt(e),targets.changeIdx=targets.objIdx,targets.enableLock()},getTargetPoint:function(e,t=0){let r={x:targeting.now.x,y:targeting.now.y};const o=tracker.wrapper.getTargetPoint(e,t);return null!=o&&(r=o),o},lock:function(e=!0){e&&(targets.search=!1,targets.lost=!1),targets.identifier=targets.tmpIdentifier,null!=targets.box.last[targets.objIdx]&&(targets.box.lock=targets.box.last[targets.objIdx]),targets.enableLock()},unlock:function(e=!0){config.target.locked=!1,e&&(targets.lost=!1,targets.search=!1),targets.tmpIdentifier=-1,targets.box.lock={xMin:0,yMin:0,width:0,height:0},ui.disableBtn("btn-target-lock"),target.clr()},onClick:function(e,t){let r=upscaler.pointerToVideoTransform(e,t);config.render.simulator&&(r.x-=tracker.dx,r.y-=tracker.dy);for(let e in tracker.objects)if(void 0!==tracker.objects[e].box&&keypoints.checkBounding(upscaler.normalize(r),tracker.objects[e].box))return void targets.switchTarget(e)},enableLock:function(){config.target.locked=!0,ui.enableBtn("btn-target-lock")},next:function(){let e=finder.findNext();null==e&&(e=finder.findFirst(),null==e&&(e=targets.objIdx,e++,void 0===tracker.objects[e]&&(e=0))),void 0!==tracker.objects[e]&&(targets.objIdx=parseInt(e),targets.changeIdx=targets.objIdx,targets.box.lock=tracker.objects[e].box,void 0!==tracker.objects[e].id&&(targets.identifier=parseInt(tracker.objects[e].id)),targets.enableLock())},prev:function(){let e=finder.findPrev();null==e&&(e=finder.findLast(),null==e&&(e=targets.objIdx,e--,void 0===tracker.objects[e]&&(e=tracker.objects.length-1))),void 0!==tracker.objects[e]&&(targets.objIdx=parseInt(e),targets.changeIdx=targets.objIdx,targets.box.lock=tracker.objects[e].box,void 0!==tracker.objects[e].id&&(targets.identifier=parseInt(tracker.objects[e].id)),targets.enableLock())},resetBoundings:function(){targets.box.lock={xMin:0,yMin:0,width:0,height:0},targets.box.current={xMin:0,yMin:0,width:0,height:0}},resizeBoundings:function(){targets.box.lock.xMin-=.01,targets.box.lock.yMin-=.01,targets.box.lock.width+=.02,targets.box.lock.height+=.02},isLocked:function(){return config.target.locked},isSearch:function(){return targets.search},isLost:function(){return targets.lost},hasTarget:function(){return targets.isTarget}},ui={clickCoords:null,handlePointerEvents:function(){null!=ui.clickCoords&&(targets.onClick(ui.clickCoords.x,ui.clickCoords.y),ui.clickCoords=null)},panelEnabled:function(e){return!(void 0===config.panel[e]||!config.panel[e])},enableBtn:function(e,t=null,r=null){let o;o="string"==typeof e||e instanceof String?null!=t?$('button[data-trigger="'+e+'"][data-id="'+t+'"]'):$('button[data-trigger="'+e+'"]'):e;let a="primary";null!=r&&(a=r),o.attr("data-enabled",1),o.removeClass("btn-success"),o.removeClass("btn-danger"),o.removeClass("btn-primary"),o.removeClass("btn-secondary"),o.addClass("btn-"+a)},disableBtn:function(e,t=null,r=null){let o;o="string"==typeof e||e instanceof String?null!=t?$('button[data-trigger="'+e+'"][data-id="'+t+'"]'):$('button[data-trigger="'+e+'"]'):e;let a="secondary";null!=r&&(a=r),o.attr("data-enabled",0),o.removeClass("btn-success"),o.removeClass("btn-danger"),o.removeClass("btn-primary"),o.removeClass("btn-secondary"),!1!==r&&o.addClass("btn-"+a)},showPanel:function(e){config.panel[e]=!0,$('.control-panel[data-id="'+e+'"]').show()},hidePanel:function(e){config.panel[e]=!1,$('.control-panel[data-id="'+e+'"]').hide()},statusAlert:function(e,t=!0,r=null){t?(null!=r&&$('.alert-monit[data-id="'+e+'"]').html(r),$('.alert-monit[data-id="'+e+'"]').show()):(null!=r&&$('.alert-monit[data-id="'+e+'"]').html(r),$('.alert-monit[data-id="'+e+'"]').hide())}},upscaler={getVideoSize:function(){return{width:Math.round(tracker.video.videoWidth,0),height:Math.round(tracker.video.videoHeight,0)}},getCanvasSize:function(){return{width:Math.round(tracker.canvas.width,0),height:Math.round(tracker.canvas.height,0)}},getCurrentCanvasSize:function(){const e=upscaler.getCanvas();return{width:Math.round(e.width(),0),height:Math.round(e.height(),0)}},getCanvas:function(){return $("#canvas")},pointerToVideo:function(e,t){const r=upscaler.getVideoSize(),o=upscaler.getCurrentCanvasSize(),a=upscaler.getCanvas(),n=upscaler.fit();let i=e-a.offset().left,c=t-a.offset().top+$(window).scrollTop(),l=0;r.width<n.width&&o.width>n.width&&(l=(o.width-n.width)/2,i-=l);let g=n.width,s=n.height;return o.width>n.width&&(g=o.width,s=o.height),o.height<n.height&&(s=o.height),i<0&&(i=0),i>g&&(i=g),c<0&&(c=0),c>s&&(c=s),{x:i,y:c}},pointerToVideoTransform:function(e,t){const r=upscaler.getVideoSize(),o=upscaler.fit(),a=upscaler.pointerToVideo(e,t),n=(upscaler.getCanvas(),upscaler.getCurrentCanvasSize());let i,c,l,g;return n.width>o.width?(l=a.x/n.width*100,i=l/100*r.width,g=a.y/n.height*100,c=g/100*r.height):n.width==o.width?(l=a.x/o.width*100,i=l/100*r.width,g=a.y/o.height*100,c=g/100*r.height,n.height<o.height&&(g=a.y/n.height*100,c=g/100*r.height)):(l=a.x/n.width*100,i=l/100*r.width,g=a.y/n.height*100,c=g/100*r.height),i>r.width&&(i=r.width),c>r.height&&(c=r.height),{x:i,y:c}},pointerToVideoDelta:function(e,t){upscaler.fit();const r=upscaler.getVideoSize();upscaler.getCanvas();let o=upscaler.pointerToVideoTransform(e,t);return{x:-(o.x-r.width)-r.width/2,y:-(o.y-r.height)-r.height/2}},pointerToVideoDeltaNormalized:function(e,t){const r=upscaler.pointerToVideoTransform(e,t),o=upscaler.getVideoSize();return{x:-r.x/o.width+.5,y:-r.y/o.height+.5}},fit:function(){const e=upscaler.getVideoSize(),t=upscaler.getCanvasSize(),r=e.width/e.height,o=t.width/t.height;if(!config.render.resize)return{width:e.width,height:t.height};switch(config.init.mode){case"camera":case"remote":return e.width<e.height?{width:Math.round(t.height*r,0),height:t.height}:{width:t.width,height:Math.round(t.width/r,0)};case"video":case"stream":return o>r?{width:Math.round(t.height*r,0),height:t.height}:{width:t.width,height:Math.round(t.width/r,0)}}},translateX:function(e){if(!config.render.resize)return config.render.simulator&&(e+=upscaler.denormalize({x:tracker.dx,y:0}).x),e;const t=upscaler.getVideoSize(),r=upscaler.getCanvasSize(),o=upscaler.fit(),a=o.width/t.width;let n=(r.width-o.width)/2;return config.render.autofit||(n=0),e=Math.ceil(e*a)+n,config.render.simulator&&(e+=upscaler.denormalize({x:tracker.dx,y:0}).x),e},translateY:function(e){if(!config.render.resize)return config.render.simulator&&(e+=upscaler.denormalize({x:0,y:tracker.dy}).y),e;const t=upscaler.getVideoSize(),r=(upscaler.getCanvasSize(),upscaler.fit().height/t.height);return yOffset=0,e=Math.ceil(e*r)+yOffset,config.render.simulator&&(e+=upscaler.denormalize({x:0,y:tracker.dy}).y),e},normalize:function(e){const t=upscaler.fit();return{x:e.x/t.width,y:e.y/t.height}},denormalize:function(e){const t=upscaler.fit();return{x:Math.round(parseFloat(e.x*t.width),0),y:Math.round(parseFloat(e.y*t.height),0)}}},mobilenet={modelFamily:"mobilenet",modelName:"MobileNet",model:null,onPrepare:function(){mobilenet.setModelFamily()},onSetModel:function(e){if("MobileNet"===e)mobilenet.detectorModel=null,mobilenet.detectorConfig={},mobilenet.minScore=.65,mobilenet.modelName=e;mobilenet.setModelFamily()},setModelFamily:function(e=null){if(null==e){if("MobileNet"===mobilenet.modelName)mobilenet.modelFamily="mobilenet"}else mobilenet.modelFamily=e},onInit:function(){},beforeUpdate:function(){for(let e of tracker.objects.keys())void 0===tracker.objects[objIdx].box&&void 0!==tracker.objects[objIdx].bbox&&(tracker.objects[objIdx].box=coco.normalizeBounding(tracker.objects[objIdx].bbox)),void 0===tracker.objects[objIdx].center&&(tracker.objects[objIdx].center=keypoints.createCenterPoint(objIdx))},onRender:function(e){const t=tracker.objects[e].score;config.render.bounds&&(void 0!==tracker.objects[e].box&&render.drawBoundings(e,t),void 0!==tracker.objects[e].center&&render.drawCenter(e,t))},normalizeBounding:function(e){const t=upscaler.getVideoSize();return{xMin:e[0]/t.width,yMin:e[1]/t.height,width:e[2]/t.width,height:e[3]/t.height}},onReady:async function(){null==mobilenet.model&&cocoSsd.load().then((function(e){mobilenet.model=e}))},onLoad:function(){},onFrame:async function(){try{mobilenet.model.detect(tracker.video).then((function(e){tracker.objects=e}))}catch(e){console.error(e)}},getTargetPoint:function(e,t=0){return 0==tracker.objects.length||void 0===tracker.objects[t]?null:tracker.objects[t].center}},OpenCVMotionDetector={modelFamily:"opencv",modelName:"OpenCVMotionDetector",accumWeight:.5,bg:null,onPrepare:function(){},onInit:function(){},beforeUpdate:function(){},onRender:function(e){const t=tracker.objects[e].score;config.render.bounds&&(void 0!==tracker.objects[e].box&&render.drawBoundings(e,t),void 0!==tracker.objects[e].center&&render.drawCenter(e,t))},onReady:async function(){},onLoad:function(){},onFrame:async function(){if(tracker.objects=[],!tracker.started)return;let e=cv.imread("canvas_source");if(0===e.cols)return;OpenCVMotionDetector.update(e);const t=OpenCVMotionDetector.detect(e);null!=t&&(tracker.objects=[{x:t.x1+t.x2/2,y:t.y1+t.y2/2,score:1,id:"__movement",label:"__movement",center:{x:t.x1+t.x2/2,y:t.y1+t.y2/2},box:{xMin:t.x1,yMin:t.y1,width:t.x2,height:t.y2}}])},onSetModel:function(e){},getTargetPoint:function(e,t=0){return 0==tracker.objects.length||void 0===tracker.objects[t]||tracker.objects[t].score<.35?null:{x:tracker.objects[t].center.x,y:tracker.objects[t].center.y}},lerp:function(e,t,r,o){0===t.cols?e.copyTo(r):0===e.cols?t.copyTo(r):(cv.addWeighted(e,o,t,1-o,0,r),OpenCVMotionDetector.bg=r)},accumulateWeighted:function(e,t,r){OpenCVMotionDetector.lerp(t,e,t,r)},update:function(e){let t=new cv.Mat;if(cv.cvtColor(e,t,cv.COLOR_BGR2GRAY),!OpenCVMotionDetector.bg)return OpenCVMotionDetector.bg=new cv.Mat,t.copyTo(OpenCVMotionDetector.bg),void t.delete();OpenCVMotionDetector.accumulateWeighted(t,OpenCVMotionDetector.bg,OpenCVMotionDetector.accumWeight),t.delete()},detect:function(e){let t=new cv.Mat,r=new cv.Mat,o=new cv.Mat,a=new cv.MatVector,n=new cv.Mat;cv.cvtColor(e,r,cv.COLOR_BGR2GRAY),cv.absdiff(OpenCVMotionDetector.bg,r,t),cv.threshold(t,o,25,255,cv.THRESH_BINARY)[1],cv.erode(o,o,new cv.Mat,new cv.Point(-1,-1),2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue()),cv.dilate(o,o,new cv.Mat,new cv.Point(-1,-1),2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue()),cv.findContours(o,a,n,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let i=[];for(let e=0;e<a.size();++e)i.push(a.get(e));let c=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;if(0===i.length)return t.delete(),e.delete(),r.delete(),o.delete(),a.delete(),n.delete(),null;for(let e=0;e<i.length;e++){let t=cv.boundingRect(i[e]),r=t.x,o=t.y,a=t.width,n=t.height;c=Math.min(c,r),l=Math.min(l,o),g=Math.max(g,r+a),s=Math.max(s,o+n),i[e].delete()}t.delete(),e.delete(),r.delete(),o.delete(),a.delete(),n.delete();const d=upscaler.getCanvasSize();return{x1:c/d.width,y1:l/d.height,x2:(g-c)/d.width,y2:(s-l)/d.height}}},movenet={modelFamily:"movenet",modelName:"MoveNetMultiPoseLightning",detector:null,detectorModel:poseDetection.SupportedModels.MoveNet,detectorConfig:{modelType:poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING,enableSmoothing:!0,multiPoseMaxDimension:256,enableTracking:!0,trackerType:poseDetection.TrackerType.BoundingBox},joints:[],targetIdx:[],onPrepare:function(){movenet.setModelFamily(),movenet.cacheJoints(),movenet.cacheTargetAnchors()},onInit:function(){movenet.detectorModel==poseDetection.SupportedModels.BlazePose&&tracker.init3D()},beforeUpdate:function(){for(let e of tracker.objects.keys())tracker.objects[e].class="person",void 0===tracker.objects[e].box&&(tracker.objects[e].box=keypoints.createBoundingBox(e)),void 0===tracker.objects[e].center&&(tracker.objects[e].center=keypoints.createCenterPoint(e))},onRender:function(e){for(let t of movenet.joints.keys()){if(void 0!==tracker.objects[e].score&&(keypoints.score=tracker.objects[e].score),keypoints.score<config.model.minScore)return;movenet.hasScore(e,t)&&(point=movenet.getCoords(e,t),score=movenet.getScore(e,t),render.drawPath(point[0],point[1],point[2],point[3],movenet.joints[t][5][0],movenet.joints[t][5][1],movenet.joints[t][5][2],score))}config.render.bounds&&(void 0!==tracker.objects[e].box&&render.drawBoundings(e,keypoints.score),void 0!==tracker.objects[e].center&&render.drawCenter(e,keypoints.score,!1)),config.core.enable3D&&void 0!==tracker.objects[e].keypoints3D&&null!=tracker.objects[e].keypoints3D&&tracker.objects[e].keypoints3D.length>0&&tracker.drawKeypoints3D(tracker.objects[e].keypoints3D)},onReady:async function(){movenet.detector=await poseDetection.createDetector(movenet.detectorModel,movenet.detectorConfig)},onLoad:async function(){null!=movenet.detector&&movenet.detector.dispose(),movenet.detector=null},onFrame:async function(){const e={flipHorizontal:!1},t=performance.now();null!=movenet.detector&&(tracker.objects=await movenet.detector.estimatePoses(tracker.video,e,t))},findPosePoint:function(e,t,r){return upscaler.normalize(tracker.objects[e].keypoints[t])[r]},findPoseScore:function(e,t){return tracker.objects[e].keypoints[t].score},getCoord:function(e,t,r,o){if(1==movenet.joints[t][r])return movenet.findPosePoint(e,movenet.joints[t][r][0],o);{let a=0;for(joint of movenet.joints[t][r])a+=movenet.findPosePoint(e,joint,o);return a/movenet.joints[t][r].length}},getCoords:function(e,t){return[movenet.getCoord(e,t,0,"x"),movenet.getCoord(e,t,1,"y"),movenet.getCoord(e,t,2,"x"),movenet.getCoord(e,t,3,"y")]},getScore:function(e,t){if(1==movenet.joints[t][4])return movenet.findPoseScore(e,movenet.joints[t][4][0]);{let r=0;for(joint of movenet.joints[t][4])r+=movenet.findPoseScore(e,joint);return r/movenet.joints[t][4].length}},hasScore:function(e,t){let r=!0;if(1==movenet.joints[t][4].length)movenet.findPoseScore(e,movenet.joints[t][4][0])<config.model.minScore&&(r=!1);else for(point of movenet.joints[t][4])if(movenet.findPoseScore(e,point)<config.model.minScore){r=!1;break}return r},getTargetPoint:function(e,t=0){if(0==tracker.objects.length||void 0===tracker.objects[t])return null;if(tracker.objects[t].score<.35)return null;let r={x:0,y:0};const o={nose:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[0]]),left_ear:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[1]]),right_ear:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[2]]),left_shoulder:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[3]]),right_shoulder:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[4]]),left_hip:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[5]]),right_hip:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[6]]),left_knee:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[7]]),right_knee:upscaler.normalize(tracker.objects[t].keypoints[movenet.targetIdx[8]]),mid_head:{},mid_body:{},mid_body_hip:{},body_heart:{},left_leg:{},right_leg:{}};switch(r.x=o.nose.x,r.y=o.nose.y,o.mid_head.x=(o.left_ear.x+o.right_ear.x)/2,o.mid_head.y=(o.left_ear.y+o.right_ear.y)/2,o.mid_body.x=(o.left_shoulder.x+o.right_shoulder.x)/2,o.mid_body.y=(o.left_shoulder.y+o.right_shoulder.y)/2,o.mid_body_hip.x=(o.left_hip.x+o.right_hip.x)/2,o.mid_body_hip.y=(o.left_hip.y+o.right_hip.y)/2,o.body_heart.x=o.mid_body.x+(o.mid_body_hip.x-o.mid_body.x)/2,o.body_heart.y=o.mid_body.y+(o.mid_body_hip.y-o.mid_body.y)/3.5,o.left_leg.x=o.left_hip.x+(o.mid_head.x-o.left_hip.x)/3,o.left_leg.y=o.left_hip.y+(o.mid_head.y-o.left_hip.y)/2,o.right_leg.x=o.right_hip.x+(o.right_knee.x-o.right_hip.x)/3,o.right_leg.y=o.right_hip.y+(o.right_knee.y-o.right_hip.y)/2,e){case"HEAD":r.x=o.mid_head.x,r.y=o.mid_head.y;break;case"NECK":r.x=o.mid_body.x,r.y=o.mid_body.y;break;case"BODY":r.x=o.body_heart.x,r.y=o.body_heart.y;break;case"LEGS":o.left_knee.score>o.right_knee.score?(r.x=o.left_leg.x,r.y=o.left_leg.y):(r.x=o.right_leg.x,r.y=o.right_leg.y);break;default:o.left_ear.score>o.left_shoulder.score&&o.left_shoulder.score<.3&&o.left_ear.score-o.left_shoulder.score>=.5?(r.x=o.mid_head.x,r.y=o.mid_head.y):(r.x=o.body_heart.x,r.y=o.body_heart.y)}return r},cacheJoints:function(){const e=config.model.paths[movenet.modelFamily];for(let t in e)if(e.hasOwnProperty(t)){for(point of(data=e[t],joint={0:[],1:[],2:[],3:[],4:[],5:[]},data.from_x))joint[0].push(config.model.keypoints[movenet.modelFamily][point]);for(point of data.from_y)joint[1].push(config.model.keypoints[movenet.modelFamily][point]);for(point of data.to_x)joint[2].push(config.model.keypoints[movenet.modelFamily][point]);for(point of data.to_y)joint[3].push(config.model.keypoints[movenet.modelFamily][point]);for(point of data.scores)joint[4].push(config.model.keypoints[movenet.modelFamily][point]);for(point of data.rgb)joint[5].push(point);movenet.joints.push(joint)}},cacheTargetAnchors:function(){const e=config.model.keypoints[movenet.modelFamily];movenet.targetIdx[0]=e.nose,movenet.targetIdx[1]=e.left_ear,movenet.targetIdx[2]=e.right_ear,movenet.targetIdx[3]=e.left_shoulder,movenet.targetIdx[4]=e.right_shoulder,movenet.targetIdx[5]=e.left_hip,movenet.targetIdx[6]=e.right_hip,movenet.targetIdx[7]=e.left_knee,movenet.targetIdx[8]=e.right_knee},onSetModel:function(e){switch(e){case"coco":movenet.detectorModel=null,movenet.detectorConfig={},config.model.minScore=.65,movenet.modelName=e;break;case"BlazePoseLite":movenet.detectorModel=poseDetection.SupportedModels.BlazePose,movenet.detectorConfig={runtime:"tfjs",enableSmoothing:!0,modelType:"lite"},config.model.minScore=.65,movenet.modelName=e;break;case"BlazePoseHeavy":movenet.detectorModel=poseDetection.SupportedModels.BlazePose,movenet.detectorConfig={runtime:"tfjs",enableSmoothing:!0,modelType:"heavy"},config.model.minScore=.65,movenet.modelName=e;break;case"BlazePoseFull":movenet.detectorModel=poseDetection.SupportedModels.BlazePose,movenet.detectorConfig={runtime:"tfjs",enableSmoothing:!0,modelType:"full"},config.model.minScore=.65,movenet.modelName=e;break;case"MoveNetSinglePoseLightning":movenet.detectorModel=poseDetection.SupportedModels.MoveNet,movenet.detectorConfig={modelType:poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING,enableSmoothing:!0,multiPoseMaxDimension:256,enableTracking:!0,movenetType:poseDetection.TrackerType.BoundingBox},config.model.minScore=.4,movenet.modelName=e;break;case"MoveNetMultiPoseLightning":movenet.detectorModel=poseDetection.SupportedModels.MoveNet,movenet.detectorConfig={modelType:poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING,enableSmoothing:!0,multiPoseMaxDimension:256,enableTracking:!0,movenetType:poseDetection.TrackerType.BoundingBox},config.model.minScore=.2,movenet.modelName=e;break;case"MoveNetSinglePoseThunder":movenet.detectorModel=poseDetection.SupportedModels.MoveNet,movenet.detectorConfig={modelType:poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,enableSmoothing:!0,multiPoseMaxDimension:256,enableTracking:!0,movenetType:poseDetection.TrackerType.BoundingBox},config.model.minScore=.4,movenet.modelName=e;break;case"PoseNetMobileNetV1":movenet.detectorModel=poseDetection.SupportedModels.PoseNet,movenet.detectorConfig={architecture:"MobileNetV1",outputStride:16,inputResolution:{width:640,height:480},multiplier:.75},config.model.minScore=.5,movenet.modelName=e;break;case"PoseNetResNet50":movenet.detectorModel=poseDetection.SupportedModels.PoseNet,movenet.detectorConfig={architecture:"ResNet50",outputStride:16,multiplier:1,inputResolution:{width:257,height:200},quantBytes:2},config.model.minScore=.5,movenet.modelName=e}movenet.setModelFamily()},setModelFamily:function(e=null){if(null==e)switch(movenet.modelName){case"coco":movenet.modelFamily="coco";break;case"BlazePoseLite":case"BlazePoseHeavy":case"BlazePoseFull":movenet.modelFamily="blazepose";break;case"MoveNetSinglePoseLightning":case"MoveNetMultiPoseLightning":case"MoveNetSinglePoseThunder":movenet.modelFamily="movenet";break;case"PoseNetMobileNetV1":case"PoseNetResNet50":movenet.modelFamily="posenet"}else movenet.modelFamily=e}};